<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <!-- Google tag (gtag.js) -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-C9RLS2SDCJ"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag() { dataLayer.push(arguments); }
    gtag('js', new Date());

    gtag('config', 'G-C9RLS2SDCJ');
  </script>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>PDV - Bar do Gigante (Comandas)</title>

  <script src="https://cdn.tailwindcss.com"></script>
  <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  
  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>

  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            dourado: '#D4AF37',
            douradoEscuro: '#B8941F',
            preto: '#1a1a1a',
            cinzaEscuro: '#2d2d2d',
          }
        }
      }
    }
  </script>

  <style>
    body { -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale; }
    .sidebar-scroll { max-height: calc(100vh - 96px); overflow:auto; }
    ::-webkit-scrollbar { width:10px; height:10px; }
    ::-webkit-scrollbar-thumb { background: linear-gradient(180deg, #D4AF37, #B8941F); border-radius:999px; }
    ::-webkit-scrollbar-track { background: transparent; }

    .logo-bar {
      width: 120px; height: 120px; margin: 0 auto; background: #1a1a1a;
      border-radius: 50%; border: 3px solid #D4AF37;
      display: flex; align-items: center; justify-content: center;
      box-shadow: 0 0 30px rgba(212, 175, 55, 0.5);
    }
    .logo-inner {
      width: 110px; height: 110px; border-radius: 50%; border: 2px solid #ffffff;
      display: flex; flex-direction: column; align-items: center; justify-content: center;
      background: linear-gradient(135deg, #2d2d2d 0%, #1a1a1a 100%); padding: 10px;
    }
    .logo-stars { display: flex; gap: 3px; margin-bottom: 5px; }
    .star { color: #D4AF37; font-size: 11px; }
    .logo-text { text-align: center; }
    .logo-bar-text {
      font-size: 22px; font-weight: bold; color: #D4AF37;
      letter-spacing: 2px; text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
      line-height: 1;
    }
    .logo-do-gigante {
      font-size: 12px; font-weight: bold; color: #ffffff;
      margin-top: 3px; letter-spacing: 1px;
    }
  </style>
</head>
<body class="bg-gradient-to-br from-slate-100 via-slate-50 to-slate-100">

  <div id="root"></div>

  <script type="text/babel">
  const { useState, useEffect, useMemo, useRef } = React;

  /**********************
   * CONFIGURA√á√ÉO FIREBASE *
   **********************/
  
  // ‚ö†Ô∏è SUBSTITUA ESTAS CREDENCIAIS PELAS SUAS DO FIREBASE!
  const firebaseConfig = {
  apiKey: "AIzaSyCB5k2sLKlSopQ5xes6e_1ctpXnHA2Pluo",
  authDomain: "bar-do-gigante.firebaseapp.com",
  databaseURL: "https://bar-do-gigante-default-rtdb.firebaseio.com",
  projectId: "bar-do-gigante",
  storageBucket: "bar-do-gigante.firebasestorage.app",
  messagingSenderId: "818575087702",
  appId: "1:818575087702:web:e488390c6f8ec6471b83f7"
};

  // Inicializa Firebase
  if (!firebase.apps.length) {
    firebase.initializeApp(firebaseConfig);
  }
  const db = firebase.database();

  /**********************
   * Utilit√°rios Firebase *
   **********************/
  const initialProdutosDefault = [
    { id: 1, nome: "Coca-Cola 2L", preco: 8.5, estoque: 50, categoria: "Bebidas" },
    { id: 2, nome: "Cerveja Skol Lata", preco: 3.2, estoque: 120, categoria: "Bebidas" },
    { id: 3, nome: "Cigarro Marlboro", preco: 12.0, estoque: 30, categoria: "Cigarros" },
    { id: 4, nome: "Palito de Dente", preco: 0.5, estoque: 200, categoria: "Diversos" },
    { id: 5, nome: "√Ågua Mineral 500ml", preco: 2.0, estoque: 100, categoria: "Bebidas" },
    { id: 6, nome: "Cacha√ßa 51", preco: 15.0, estoque: 10, categoria: "Destilados" },
    { id: 7, nome: "Salgadinho Elma Chips", preco: 4.5, estoque: 45, categoria: "Petiscos" },
    { id: 8, nome: "Pinga Artesanal", preco: 25.0, estoque: 5, categoria: "Destilados" },
  ];

  function uid(){ return Date.now() + Math.floor(Math.random()*9999); }
  function currency(v){ return 'R$ ' + Number(v||0).toFixed(2).replace('.', ','); }

  // Fun√ß√µes Firebase (substituem localStorage)
  async function storageGet(key, fallback=null){ 
    try {
      const snapshot = await db.ref(key).once('value');
      return snapshot.exists() ? snapshot.val() : fallback;
    } catch(e){ 
      console.error('Erro ao ler Firebase:', e);
      return fallback; 
    }
  }

  async function storageSet(key, value){ 
    try {
      await db.ref(key).set(value);
    } catch(e){
      console.error('Erro ao salvar Firebase:', e);
    }
  }

  function storageWatch(key, callback) {
    db.ref(key).on('value', (snapshot) => {
      if (snapshot.exists()) {
        callback(snapshot.val());
      }
    });
  }

  /**********
   * Login *
   **********/
  const defaultUser = { username: 'admin', password: '1234' };

  function Login({onLogin}){
    const [u, setU] = useState('');
    const [p, setP] = useState('');
    const [err, setErr] = useState('');

    function submit(e){
      e.preventDefault();
      if(u === defaultUser.username && p === defaultUser.password){
        onLogin({username: u});
      } else {
        setErr('Usu√°rio ou senha inv√°lidos');
      }
    }

    return (
      <div className="min-h-screen flex items-center justify-center p-6 bg-gradient-to-br from-cinzaEscuro via-preto to-cinzaEscuro">
        <div className="max-w-4xl w-full grid grid-cols-1 md:grid-cols-2 gap-8 items-center">
          <div className="hidden md:flex flex-col items-center justify-center rounded-2xl p-8 bg-cinzaEscuro shadow-xl border-2 border-dourado">
            <div className="logo-bar mb-4">
              <div className="logo-inner">
                <div className="logo-stars">
                  <span className="star">‚òÖ</span>
                  <span className="star">‚òÖ</span>
                  <span className="star">‚òÖ</span>
                  <span className="star">‚òÖ</span>
                  <span className="star">‚òÖ</span>
                </div>
                <div className="logo-text">
                  <div className="logo-bar-text">BAR</div>
                  <div className="logo-do-gigante">DO GIGANTE</div>
                </div>
              </div>
            </div>
            <h1 className="text-3xl font-extrabold text-dourado">Bar do Gigante</h1>
            <p className="mt-2 text-gray-300">PDV moderno e funcional</p>
            <div className="mt-6 text-sm text-gray-400">Dica: usu√°rio <b className="text-dourado">admin</b> / senha <b className="text-dourado">1234</b></div>
          </div>

          <form onSubmit={submit} className="bg-cinzaEscuro border-2 border-dourado rounded-2xl p-6 shadow-lg">
            <div className="flex items-center justify-between mb-6">
              <div>
                <h2 className="text-2xl font-bold text-dourado">Entrar</h2>
                <p className="text-sm text-gray-300">Acesse o sistema PDV</p>
              </div>
              <div className="text-2xl">üîí</div>
            </div>

            <label className="block mb-4">
              <span className="text-sm text-gray-300">Usu√°rio</span>
              <input className="mt-1 block w-full p-3 border border-dourado bg-preto text-white rounded-xl focus:outline-none focus:ring-2 focus:ring-dourado transition" value={u} onChange={e=>setU(e.target.value)} required />
            </label>

            <label className="block mb-4">
              <span className="text-sm text-gray-300">Senha</span>
              <input type="password" className="mt-1 block w-full p-3 border border-dourado bg-preto text-white rounded-xl focus:outline-none focus:ring-2 focus:ring-dourado transition" value={p} onChange={e=>setP(e.target.value)} required />
            </label>

            {err && <div className="text-red-400 mb-3">{err}</div>}

            <button className="w-full py-3 rounded-xl font-bold bg-gradient-to-r from-dourado to-douradoEscuro text-preto shadow-md hover:shadow-lg transform hover:-translate-y-0.5 transition">Entrar</button>
          </form>
        </div>
      </div>
    );
  }

  /****************
   * Header, Side *
   ****************/
  function Header({user, onLogout}){
    return (
      <header className="bg-white shadow sticky top-0 z-30">
        <div className="max-w-7xl mx-auto px-4 py-3 flex items-center justify-between">
          <div className="flex items-center gap-4">
            <div className="text-3xl">üçª</div>
            <div>
              <div className="text-lg font-bold bg-clip-text text-transparent bg-gradient-to-r from-indigo-600 to-purple-600">Bar do Gigante</div>
              <div className="text-xs text-gray-500 hidden sm:block">Sistema PDV (Firebase)</div>
            </div>
          </div>

          <div className="flex items-center gap-4">
            <div className="flex items-center gap-2 bg-gray-50 px-3 py-1 rounded-full shadow-sm">
              <div className="text-sm text-gray-700">üë§ {user?.username}</div>
            </div>
            <button onClick={onLogout} className="px-3 py-1 rounded-lg border hover:bg-gray-50 transition">Sair</button>
          </div>
        </div>
      </header>
    );
  }

  function Sidebar({selected, setSelected}){
    const itens = [
      { key:'pdv', label:'üõí PDV' },
      { key:'pedidos', label:'üîî Pedidos' },
      { key:'comandas', label:'üí≥ Comandas Abertas' },
      { key:'produtos', label:'üì¶ Produtos' },
      { key:'relatorios', label:'üìä Relat√≥rios' },
      { key:'avancado', label:'üìà Relat√≥rio Avan√ßado' }
    ];
    return (
      <aside className="w-64 bg-white border-r hidden md:block">
        <div className="p-4 sidebar-scroll">
          {itens.map(i=>(
            <button key={i.key} onClick={()=>setSelected(i.key)}
              className={`flex items-center gap-3 w-full text-left px-3 py-3 rounded-xl my-1 font-medium transition ${selected===i.key ? 'bg-gradient-to-r from-indigo-600 to-purple-600 text-white shadow-lg' : 'hover:bg-indigo-50'}`}>
              <span>{i.label}</span>
            </button>
          ))}
        </div>
      </aside>
    );
  }

  /*********************
   * PDV & Comandas *
   *********************/
  function PDVView({produtos, adicionarAoCarrinho, busca, setBusca, carrinho, alterarQuantidade, removerDoCarrinho, finalizarVenda, totalCarrinho, abrirComanda}){
    const produtosFiltrados = produtos.filter(p => p.nome.toLowerCase().includes(busca.toLowerCase()) || p.categoria.toLowerCase().includes(busca.toLowerCase()));

    return (
      <div className="space-y-4">
        <div className="bg-white p-4 rounded-2xl shadow flex gap-3 items-center">
          <input value={busca} onChange={e=>setBusca(e.target.value)} placeholder="Pesquisar produto ou categoria" className="flex-1 p-3 border rounded-xl focus:ring-2 focus:ring-indigo-200 transition" />
        </div>

        <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
          <div className="lg:col-span-2">
            <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">
              {produtosFiltrados.map(produto => (
                <div key={produto.id}
                     onClick={()=>adicionarAoCarrinho(produto)}
                     className="p-4 rounded-2xl border cursor-pointer shadow-sm hover:shadow-lg transform hover:-translate-y-1 transition bg-white">
                  <div className="flex items-start justify-between gap-3">
                    <div>
                      <div className="text-sm text-gray-500">{produto.categoria}</div>
                      <div className="font-semibold text-lg mt-1">{produto.nome}</div>
                    </div>
                    <div className="text-right">
                      <div className="text-green-600 font-bold text-lg">{currency(produto.preco)}</div>
                      <div className="text-xs mt-2">
                        {produto.estoque <= 10 ? (
                          <span className="inline-flex items-center gap-2 px-2 py-1 rounded-full text-red-700 bg-red-50 text-xs font-semibold">‚ö†Ô∏è {produto.estoque}</span>
                        ) : (
                          <span className="inline-flex items-center gap-2 px-2 py-1 rounded-full text-gray-700 bg-gray-50 text-xs">üì¶ {produto.estoque}</span>
                        )}
                      </div>
                    </div>
                  </div>
                </div>
              ))}
            </div>
          </div>

          <div className="bg-white p-4 rounded-2xl shadow h-full flex flex-col">
            <h3 className="font-bold text-lg flex items-center gap-2">üßæ Carrinho</h3>

            <div className="mt-3 flex-1 max-h-96 overflow-y-auto space-y-3">
              {carrinho.map(item=>(
                <div key={item.id} className="p-3 border rounded-lg">
                  <div className="flex items-start justify-between">
                    <div>
                      <div className="font-medium">{item.nome}</div>
                      <div className="text-xs text-gray-500">{item.categoria}</div>
                    </div>
                    <div className="text-right">
                      <div className="font-semibold text-green-600">{currency(item.preco * item.quantidade)}</div>
                    </div>
                  </div>

                  <div className="mt-3 flex items-center gap-2">
                    <button onClick={()=>alterarQuantidade(item.id, item.quantidade - 1)} className="px-3 py-1 border rounded-lg hover:bg-gray-50 transition">‚àí</button>
                    <div className="px-3">{item.quantidade}</div>
                    <button onClick={()=>alterarQuantidade(item.id, item.quantidade + 1)} className="px-3 py-1 border rounded-lg hover:bg-gray-50 transition">+</button>
                    <button onClick={()=>removerDoCarrinho(item.id)} className="ml-auto text-red-600 hover:underline">Remover</button>
                  </div>
                </div>
              ))}

              {carrinho.length===0 && <div className="text-gray-500 text-center py-6">Carrinho vazio</div>}
            </div>

            <div className="mt-4 border-t pt-3">
              <div className="flex items-center justify-between font-bold text-lg mb-3">
                <div>Total</div>
                <div className="text-green-600">{currency(totalCarrinho)}</div>
              </div>
              
              <button onClick={abrirComanda} 
                      disabled={carrinho.length === 0}
                      className="w-full py-3 mb-2 rounded-xl font-bold bg-indigo-500 text-white shadow hover:shadow-lg transition disabled:opacity-50">
                Abrir Comanda
              </button>

              <button onClick={finalizarVenda} 
                      disabled={carrinho.length === 0}
                      className="w-full py-3 rounded-xl font-bold bg-gradient-to-r from-green-500 to-teal-400 text-white shadow hover:shadow-lg transition disabled:opacity-50">
                Finalizar Venda Direta
              </button>
            </div>
          </div>
        </div>
      </div>
    );
  }
  
  function ComandasView({ comandas, fecharComandaEGerarVenda, consumirItemPrePago }){
    const comandasAbertas = comandas.filter(c => c.status === 'Aberta');

    function fecharComanda(comanda) {
      const itensRestantes = comanda.itensPrePagos.reduce((count, item) => count + item.quantidadeDisponivel, 0);
      if (itensRestantes > 0) {
        if (!confirm(`ATEN√á√ÉO! ${itensRestantes} itens dispon√≠veis ser√£o perdidos. Continuar?`)) return;
      }
      if (confirm(`Fechar Comanda ${comanda.nomeCliente}?`)) {
        fecharComandaEGerarVenda(comanda);
      }
    }

    function consumirItem(comandaId, itemId, quantidade = 1) {
      const comanda = comandas.find(c => c.id === comandaId);
      const item = comanda.itensPrePagos.find(i => i.id === itemId);
      if (item.quantidadeDisponivel < quantidade) {
        alert(`Apenas ${item.quantidadeDisponivel} dispon√≠veis.`);
        return;
      }
      if (confirm(`Confirmar consumo de ${quantidade}x ${item.nome}?`)) {
        consumirItemPrePago(comandaId, itemId, quantidade);
      }
    }

    return (
      <div className="space-y-6">
        <h2 className="text-3xl font-extrabold text-gray-800 border-b pb-2 flex items-center gap-3">
          <span className="text-4xl">üí≥</span> Comandas Abertas
        </h2>

        <div className="grid grid-cols-1 lg:grid-cols-2 xl:grid-cols-3 gap-6">
          {comandasAbertas.map(c => (
            <div key={c.id} className="p-4 rounded-2xl shadow-lg border-2 border-indigo-500 bg-white">
              <h3 className="font-bold text-xl text-indigo-700">{c.nomeCliente}</h3>
              <p className="text-sm text-gray-600 font-semibold mb-3">Mesa: <span className="text-red-500">{c.mesaFixa}</span></p>
              <p className="text-xs text-gray-500">Pago: {currency(c.valorInicial)}</p>
              
              <div className="border-t pt-2 mt-2">
                <h4 className="font-bold text-lg mb-2 text-purple-600">Itens:</h4>
                {c.itensPrePagos.map(item => (
                  <div key={item.id} className="flex justify-between items-center py-2 border-b">
                    <span className="font-medium">{item.nome}</span>
                    <div className="flex items-center gap-2">
                      <span className="font-bold text-xl text-green-600">{item.quantidadeDisponivel}</span>
                      {item.quantidadeDisponivel > 0 ? (
                        <button 
                          onClick={() => consumirItem(c.id, item.id)}
                          className="px-3 py-1 bg-green-500 text-white rounded-lg text-sm hover:bg-green-600"
                        >
                          Consumir
                        </button>
                      ) : (
                        <span className="text-xs text-gray-400">Esgotado</span>
                      )}
                    </div>
                  </div>
                ))}
              </div>
              
              <button 
                onClick={() => fecharComanda(c)}
                className="w-full py-2 mt-4 bg-red-500 text-white rounded-lg hover:bg-red-600 transition font-semibold"
              >
                Fechar Comanda
              </button>
            </div>
          ))}

          {comandasAbertas.length === 0 && (
            <div className="md:col-span-3 text-center text-gray-500 p-8 border rounded-xl bg-gray-50">Nenhuma comanda ativa</div>
          )}
        </div>
      </div>
    );
  }

  function PedidosView({ pedidos, setPedidos, finalizarPedidoEGerarVenda, comandas }) {
    function alterarStatus(id, novoStatus) {
      const novosPedidos = pedidos.map(p => p.id === id ? { ...p, status: novoStatus } : p);
      setPedidos(novosPedidos);
    }
    
    const pedidosDeVenda = pedidos.filter(p => p.tipo !== 'Consumo Pre-pago' && p.status !== 'Vendido');
    const pedidosConsumo = pedidos.filter(p => p.tipo === 'Consumo Pre-pago');
    
    const pedidosPendentes = pedidosDeVenda.filter(p => p.status === 'Pendente');
    const pedidosEmPreparo = pedidosDeVenda.filter(p => p.status === 'Em Preparo');
    const pedidosConsumoAtivos = pedidosConsumo.filter(p => p.status === 'Em Preparo');
    const listaEmPreparo = pedidosEmPreparo.concat(pedidosConsumoAtivos);
    
    const comandaMap = useMemo(() => {
      return comandas.reduce((map, c) => {
        map[c.id] = c;
        return map;
      }, {});
    }, [comandas]);

    function marcarConsumoComoEntregue(pedido) {
      if (!confirm(`Marcar como entregue?`)) return;
      const novosPedidos = pedidos.map(p => p.id === pedido.id ? { ...p, status: 'Consumo Entregue' } : p);
      setPedidos(novosPedidos);
    }
    
    const pedidosFinalizados = pedidos.filter(p => p.status === 'Vendido' || p.status === 'Consumo Entregue');

    return (
      <div className="space-y-6">
        <h2 className="text-3xl font-extrabold text-gray-800 border-b pb-2 flex items-center gap-3">
          <span className="text-4xl">üîî</span> Gest√£o de Pedidos
        </h2>
        
        <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
          <div className="p-4 rounded-2xl shadow border border-red-200 bg-red-50">
            <h3 className="font-bold text-xl mb-4 text-red-700">NOVOS - {pedidosPendentes.length}</h3>
            <div className="space-y-4 max-h-[70vh] overflow-y-auto">
              {pedidosPendentes.map(p => (
                <div key={p.id} className="p-3 bg-white rounded-xl shadow-md border border-red-300">
                  <div className="font-bold text-lg text-red-600">{p.nomeCliente}</div>
                  <ul className="list-disc list-inside text-sm mb-3 ml-3">
                    {p.itens.map(it => <li key={it.id}>{it.quantidade}x {it.nome}</li>)}
                  </ul>
                  <button onClick={() => alterarStatus(p.id, 'Em Preparo')} className="w-full mt-3 py-2 bg-indigo-500 text-white rounded-lg hover:bg-indigo-600">Iniciar</button>
                </div>
              ))}
              {pedidosPendentes.length === 0 && <div className="text-gray-500 text-center py-6">Nenhum novo</div>}
            </div>
          </div>

          <div className="p-4 rounded-2xl shadow border border-yellow-200 bg-yellow-50">
            <h3 className="font-bold text-xl mb-4 text-yellow-700">EM PREPARO - {listaEmPreparo.length}</h3>
            <div className="space-y-4 max-h-[70vh] overflow-y-auto">
              {listaEmPreparo.map(p => {
                const isConsumo = p.tipo === 'Consumo Pre-pago';
                const comandaInfo = comandaMap[p.comandaId];
                
                return (
                  <div key={p.id} className={`p-3 bg-white rounded-xl shadow-md border ${isConsumo ? 'border-purple-300' : 'border-yellow-300'}`}>
                    <div className={`font-bold text-xl ${isConsumo ? 'text-purple-600' : 'text-yellow-600'}`}>
                      {p.nomeCliente}
                    </div>
                    <ul className="list-disc list-inside text-sm mb-3 ml-3">
                      {p.itens.map(it => <li key={it.id}>{it.quantidade}x {it.nome}</li>)}
                    </ul>
                    <div className="font-bold text-lg">{currency(p.total)}</div>
                    
                    {isConsumo ? (
                      <button 
                        onClick={() => marcarConsumoComoEntregue(p)} 
                        className="w-full mt-3 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700"
                      >
                        Marcar Entregue
                      </button>
                    ) : (
                      <button 
                        onClick={() => finalizarPedidoEGerarVenda(p)} 
                        className="w-full mt-3 py-2 bg-green-500 text-white rounded-lg hover:bg-green-600"
                      >
                        Finalizar Venda
                      </button>
                    )}
                  </div>
                );
              })}
              {listaEmPreparo.length === 0 && <div className="text-gray-500 text-center py-6">Nenhum em preparo</div>}
            </div>
          </div>
          
          <div className="p-4 rounded-2xl shadow border border-green-200 bg-green-50">
            <h3 className="font-bold text-xl mb-4 text-green-700">FINALIZADOS - {pedidosFinalizados.length}</h3>
            <div className="space-y-4 max-h-[70vh] overflow-y-auto">
              {pedidosFinalizados.slice(0, 5).map(p => ( 
                <div key={p.id} className="p-3 bg-white rounded-xl shadow-md border border-green-300">
                  <div className="font-bold text-lg text-green-600">{p.nomeCliente}</div>
                  <div className="text-right font-bold text-lg">{currency(p.total)}</div>
                </div>
              ))}
            </div>
          </div>
        </div>
      </div>
    );
  }
  
  function ProdutosView({produtos, salvarProdutos}){
    const [form, setForm] = useState({ id:null, nome:'', preco:'', estoque:'', categoria:'' });

    function submit(e){
      e.preventDefault();
      if(!form.nome || !form.preco || !form.estoque) return alert('Preencha os campos obrigat√≥rios');
      const novo = { ...form, preco: Number(form.preco), estoque: Number(form.estoque), id: form.id || uid() };
      let novos;
      if(form.id) novos = produtos.map(p=> p.id===form.id ? novo : p);
      else novos = [...produtos, novo];
      salvarProdutos(novos);
      setForm({ id:null, nome:'', preco:'', estoque:'', categoria:'' });
    }

    function editar(p){ setForm({...p, preco: String(p.preco), estoque: String(p.estoque)}); }
    function excluir(p){ if(!confirm(`Excluir ${p.nome}?`)) return; salvarProdutos(produtos.filter(x=>x.id!==p.id)); }

    return (
      <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
        <div className="bg-white p-4 rounded-2xl shadow">
          <h3 className="font-bold mb-3">{form.id ? 'Editar' : 'Novo'} Produto</h3>
          <form onSubmit={submit} className="space-y-3">
            <input value={form.nome} onChange={e=>setForm({...form, nome:e.target.value})} placeholder="Nome" className="w-full p-3 border rounded-xl" required />
            <input value={form.preco} onChange={e=>setForm({...form, preco:e.target.value})} placeholder="Pre√ßo" type="number" step="0.01" className="w-full p-3 border rounded-xl" required />
            <input value={form.estoque} onChange={e=>setForm({...form, estoque:e.target.value})} placeholder="Estoque" type="number" className="w-full p-3 border rounded-xl" required />
            <input value={form.categoria} onChange={e=>setForm({...form, categoria:e.target.value})} placeholder="Categoria" className="w-full p-3 border rounded-xl" />

            <div className="flex gap-3">
              <button className="flex-1 py-3 bg-gradient-to-r from-indigo-600 to-purple-600 text-white rounded-xl font-semibold shadow">{form.id ? 'Atualizar' : 'Adicionar'}</button>
              {form.id && <button type="button" onClick={()=>setForm({ id:null, nome:'', preco:'', estoque:'', categoria:'' })} className="py-3 px-4 border rounded-xl">Cancelar</button>}
            </div>
          </form>
        </div>

        <div className="lg:col-span-2 bg-white p-4 rounded-2xl shadow">
          <h3 className="font-bold mb-3">Produtos</h3>
          <div className="overflow-x-auto">
            <table className="w-full text-sm">
              <thead className="bg-gradient-to-r from-indigo-50 to-purple-50">
                <tr>
                  <th className="p-3 text-left">Produto</th>
                  <th className="p-3 text-left">Categoria</th>
                  <th className="p-3 text-right">Pre√ßo</th>
                  <th className="p-3 text-right">Estoque</th>
                  <th className="p-3 text-center">A√ß√µes</th>
                </tr>
              </thead>
              <tbody>
                {produtos.map(p=>(
                  <tr key={p.id} className="border-b hover:bg-gray-50">
                    <td className="p-3">{p.nome}</td>
                    <td className="p-3">{p.categoria}</td>
                    <td className="p-3 text-right">{currency(p.preco)}</td>
                    <td className={`p-3 text-right ${p.estoque<=10 ? 'text-red-600 font-bold' : ''}`}>{p.estoque}</td>
                    <td className="p-3 text-center">
                      <div className="flex items-center justify-center gap-3">
                        <button onClick={()=>editar(p)} className="text-indigo-600 hover:underline">Editar</button>
                        <button onClick={()=>excluir(p)} className="text-red-600 hover:underline">Excluir</button>
                      </div>
                    </td>
                  </tr>
                ))}
              </tbody>
            </table>
          </div>
        </div>
      </div>
    );
  }
  
  function RelatoriosView({ vendas, produtos }) {
    const areaRef = useRef(null);
    const barRef = useRef(null);
    
    const series = useMemo(() => {
      const map = {};
      vendas.forEach(v => {
        const day = v.data.split('T')[0];
        map[day] = (map[day] || 0) + v.total;
      });
      const arr = Object.entries(map).map(([d, t]) => ({ date: d, total: t }));
      arr.sort((a, b) => a.date.localeCompare(b.date));
      return arr;
    }, [vendas]);

    const top = useMemo(() => {
      const vendaMap = {};
      let totalUnidadesVendidas = 0; 

      vendas.forEach(v => {
        v.itens.forEach(it => {
          vendaMap[it.id] = vendaMap[it.id] || { nome: it.nome, quantidade: 0, total: 0 };
          vendaMap[it.id].quantidade += it.quantidade;
          vendaMap[it.id].total += it.preco * it.quantidade;
          totalUnidadesVendidas += it.quantidade; 
        });
      });

      const topProdutosComDistribuicao = Object.values(vendaMap)
        .sort((a, b) => b.quantidade - a.quantidade)
        .slice(0, 6)
        .map(p => ({
          ...p,
          distribuicao: totalUnidadesVendidas > 0 ? (p.quantidade / totalUnidadesVendidas) * 100 : 0
        }));
        
      return {
        list: topProdutosComDistribuicao,
        totalUnidades: totalUnidadesVendidas
      };
    }, [vendas]);

    useEffect(() => {
      if (areaRef.current && areaRef.current._chart) { try { areaRef.current._chart.destroy(); } catch { } }
      if (barRef.current && barRef.current._chart) { try { barRef.current._chart.destroy(); } catch { } }
      
      if (areaRef.current && series.length > 0) {
        const ctx = areaRef.current.getContext('2d');
        const labels = series.map(s => s.date.substring(5));
        const data = series.map(s => s.total);
        areaRef.current._chart = new Chart(ctx, {
          type: 'line',
          data: { labels, datasets: [{ 
            label: 'Receita (R$)', data, fill: true, tension: 0.3, 
            borderColor: '#8b5cf6', 
            backgroundColor: 'rgba(124,58,237,0.12)' 
          }] },
          options: { responsive: true, maintainAspectRatio: false }
        });
      }

      if (barRef.current && top.list.length > 0) {
        const ctx = barRef.current.getContext('2d');
        const labels = top.list.map(t => t.nome);
        const data = top.list.map(t => t.quantidade);
        barRef.current._chart = new Chart(ctx, { 
          type: 'bar', 
          data: { labels, datasets: [{ label:'Quantidade', data, backgroundColor: '#4f46e5' }] }, 
          options: { indexAxis:'y', responsive:true, maintainAspectRatio:false } 
        });
      }
    }, [series, top.list]);

    return (
      <div className="space-y-4">
        <h2 className="text-3xl font-extrabold text-gray-800 border-b pb-2">üìä Relat√≥rios</h2>
        
        <div className="grid grid-cols-1 lg:grid-cols-3 gap-4">
          <div className="lg:col-span-2 bg-white p-4 rounded-2xl shadow">
            <h4 className="font-bold mb-2">Receita por dia</h4>
            <div style={{ height: 240 }}>
              {series.length > 0 ? <canvas ref={areaRef}></canvas> : <div className="text-gray-500 text-center py-10">Sem dados</div>}
            </div>
          </div>

          <div className="bg-white p-4 rounded-2xl shadow">
            <h4 className="font-bold mb-3">Top 6 Produtos</h4>
            {top.list.length > 0 ? (
              <div className="space-y-3">
                {top.list.map((p, i) => (
                  <div key={p.nome} className="text-sm">
                    <div className="flex justify-between">
                      <span className="font-medium">{i + 1}. {p.nome}</span>
                      <span className="font-bold text-indigo-600">{p.distribuicao.toFixed(1)}%</span>
                    </div>
                    <div className="mt-1 w-full bg-gray-200 rounded-full h-2">
                      <div className="h-2 rounded-full bg-gradient-to-r from-indigo-500 to-purple-500" style={{ width: `${p.distribuicao}%` }}></div>
                    </div>
                  </div>
                ))}
              </div>
            ) : (
              <div className="text-gray-500 text-center py-6">Sem dados</div>
            )}
          </div>
        </div>
      </div>
    );
  }

  function RelatorioAvancado({ vendas }) { 
    const [from, setFrom] = useState('');
    const [to, setTo] = useState('');
    const chartRef = useRef(null);

    const vendasFiltradas = useMemo(() => {
      let filtered = vendas;
      if (from) filtered = filtered.filter(v => v.data.split('T')[0] >= from);
      if (to) filtered = filtered.filter(v => v.data.split('T')[0] <= to);
      return filtered;
    }, [vendas, from, to]);

    const stats = useMemo(() => {
      const totalVendas = vendasFiltradas.length;
      const receitaTotal = vendasFiltradas.reduce((acc, v) => acc + v.total, 0);
      const ticketMedio = totalVendas > 0 ? receitaTotal / totalVendas : 0;

      const productsSold = {};
      vendasFiltradas.forEach(v => {
        v.itens.forEach(item => {
          productsSold[item.id] = productsSold[item.id] || { nome: item.nome, quantidade: 0, total: 0 };
          productsSold[item.id].quantidade += item.quantidade;
          productsSold[item.id].total += item.preco * item.quantidade;
        });
      });

      const topProdutos = Object.values(productsSold).sort((a, b) => b.quantidade - a.quantidade).slice(0, 6);

      return { totalVendas, receitaTotal, ticketMedio, topProdutos };
    }, [vendasFiltradas]);

    return (
      <div className="space-y-6">
        <h2 className="text-3xl font-extrabold text-gray-800 border-b pb-2">üìà Relat√≥rio Avan√ßado</h2>

        <div className="bg-white border p-4 rounded-2xl shadow">
          <h3 className="font-bold mb-3">Filtros</h3>
          <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
            <label className="block">
              <span className="text-sm text-gray-500">Data Inicial</span>
              <input type="date" value={from} onChange={e => setFrom(e.target.value)} className="mt-1 block w-full p-3 border rounded-xl" />
            </label>
            <label className="block">
              <span className="text-sm text-gray-500">Data Final</span>
              <input type="date" value={to} onChange={e => setTo(e.target.value)} className="mt-1 block w-full p-3 border rounded-xl" />
            </label>
          </div>

          <div className="mt-6 grid grid-cols-3 gap-4">
            <div className="bg-gray-50 p-3 rounded-xl text-center">
              <div className="text-xs text-gray-500">Total Vendas</div>
              <div className="font-bold text-lg">{stats.totalVendas}</div>
            </div>
            <div className="bg-gray-50 p-3 rounded-xl text-center">
              <div className="text-xs text-gray-500">Receita</div>
              <div className="font-bold text-lg text-green-600">{currency(stats.receitaTotal)}</div>
            </div>
            <div className="bg-gray-50 p-3 rounded-xl text-center">
              <div className="text-xs text-gray-500">Ticket M√©dio</div>
              <div className="font-bold text-lg">{currency(stats.ticketMedio)}</div>
            </div>
          </div>
        </div>
      </div>
    );
  }

  /****************
   * Main App *
   ****************/
  function App(){
    const [user, setUser] = useState(null);
    const [loading, setLoading] = useState(true);
    
    const [produtos, setProdutos] = useState([]);
    const [vendas, setVendas] = useState([]);
    const [pedidos, setPedidos] = useState([]);
    const [comandas, setComandas] = useState([]);
    
    const [carrinho, setCarrinho] = useState([]);
    const [busca, setBusca] = useState('');
    const [selected, setSelected] = useState('pdv');

    // Carrega dados do Firebase na inicializa√ß√£o
    useEffect(() => {
      async function initData() {
        try {
          // Inicializa produtos se n√£o existirem
          let prods = await storageGet('produtos', null);
          if (!prods || prods.length === 0) {
            await storageSet('produtos', initialProdutosDefault);
            prods = initialProdutosDefault;
          }
          
          const vends = await storageGet('vendas', []);
          const peds = await storageGet('pedidos', []);
          const coms = await storageGet('comandas', []);
          
          setProdutos(prods);
          setVendas(vends);
          setPedidos(peds);
          setComandas(coms);
        } catch(e) {
          console.error('Erro ao carregar dados:', e);
          alert('Erro ao conectar com Firebase. Verifique as credenciais!');
        } finally {
          setLoading(false);
        }
      }
      
      initData();
      
      // Escuta mudan√ßas em tempo real
      storageWatch('pedidos', setPedidos);
      storageWatch('comandas', setComandas);
      storageWatch('produtos', setProdutos);
      
      return () => {
        db.ref('pedidos').off();
        db.ref('comandas').off();
        db.ref('produtos').off();
      };
    }, []);

    // Salva automaticamente quando dados mudam
    useEffect(() => { if (!loading && produtos.length > 0) storageSet('produtos', produtos); }, [produtos, loading]);
    useEffect(() => { if (!loading) storageSet('vendas', vendas); }, [vendas, loading]);
    useEffect(() => { if (!loading) storageSet('pedidos', pedidos); }, [pedidos, loading]);
    useEffect(() => { if (!loading) storageSet('comandas', comandas); }, [comandas, loading]);

    const salvarProdutos = (novos) => setProdutos(novos);

    function adicionarAoCarrinho(produto){ 
      const itemExistente = carrinho.find(i=>i.id===produto.id);
      const produtoEmEstoque = produtos.find(p=>p.id===produto.id);

      if (produtoEmEstoque.estoque <= (itemExistente?.quantidade || 0)) {
        alert(`Estoque insuficiente para ${produto.nome}`);
        return;
      }

      if(itemExistente){
        setCarrinho(carrinho.map(i => i.id===produto.id ? {...i, quantidade: i.quantidade+1} : i));
      } else {
        setCarrinho([...carrinho, {...produto, quantidade:1}]);
      }
    }

    function alterarQuantidade(id, novaQuantidade){ 
      const produtoEmEstoque = produtos.find(p=>p.id===id);
      
      if(novaQuantidade <= 0) {
        removerDoCarrinho(id);
      } else if (novaQuantidade > produtoEmEstoque.estoque) {
        alert(`M√°ximo: ${produtoEmEstoque.estoque}`);
      } else {
        setCarrinho(carrinho.map(i=> i.id===id ? {...i, quantidade:novaQuantidade} : i));
      }
    }

    function removerDoCarrinho(id){ setCarrinho(carrinho.filter(i=>i.id!==id)); }

    function finalizarVenda(){
      if(carrinho.length === 0) return alert('Carrinho vazio!');
      const total = carrinho.reduce((s,i)=> s + i.preco * i.quantidade, 0);
      
      const venda = { 
        id: uid(), 
        data: new Date().toISOString(), 
        itens: carrinho.map(i => ({ id: i.id, nome: i.nome, preco: i.preco, quantidade: i.quantidade })), 
        total: total,
        origem: 'PDV Balc√£o' 
      };
      
      const novosProdutos = produtos.map(produto => {
        const itemVendido = carrinho.find(item => item.id === produto.id);
        if(itemVendido) return {...produto, estoque: produto.estoque - itemVendido.quantidade};
        return produto;
      });
      
      salvarProdutos(novosProdutos);
      setVendas([...vendas, venda]);
      setCarrinho([]);
      alert(`Venda finalizada! Total: ${currency(total)}`);
    }
    
    function abrirComanda(){
      if(carrinho.length === 0) return alert('Carrinho vazio!');
      
      const nomeCliente = prompt("Nome do cliente:");
      if (!nomeCliente || nomeCliente.trim() === '') return alert("Nome obrigat√≥rio");

      const novosProdutos = produtos.map(produto => {
        const itemComprado = carrinho.find(item => item.id === produto.id);
        if(itemComprado) return {...produto, estoque: produto.estoque - itemComprado.quantidade};
        return produto;
      });
      salvarProdutos(novosProdutos);

      const novaComanda = {
        id: uid(),
        dataAbertura: new Date().toISOString(),
        nomeCliente: nomeCliente.trim(),
        mesaFixa: `MESA ${comandas.length + 1}`,
        valorInicial: totalCarrinho,
        status: 'Aberta',
        itensPrePagos: carrinho.map(i => ({ 
          id: i.id, 
          nome: i.nome, 
          quantidadeTotal: i.quantidade,
          quantidadeDisponivel: i.quantidade,
          preco: i.preco
        })), 
      };

      setComandas([...comandas, novaComanda]);
      setCarrinho([]);
      setSelected('comandas');
      alert(`Comanda ${novaComanda.nomeCliente} aberta!`);
    }
    
    function consumirItemPrePago(comandaId, itemId, quantidade = 1) {
      const novasComandas = comandas.map(comanda => {
        if (comanda.id === comandaId) {
          const novosItens = comanda.itensPrePagos.map(item => {
            if (item.id === itemId) {
              return {...item, quantidadeDisponivel: item.quantidadeDisponivel - quantidade}; 
            }
            return item;
          });
          return {...comanda, itensPrePagos: novosItens};
        }
        return comanda;
      });

      setComandas(novasComandas);
      
      const comanda = comandas.find(c => c.id === comandaId);
      const itemConsumido = comanda.itensPrePagos.find(i => i.id === itemId);
      
      const registroConsumo = {
        id: uid(),
        data: new Date().toISOString(),
        nomeCliente: comanda.nomeCliente,
        itens: [{ id: itemId, nome: itemConsumido.nome, preco: itemConsumido.preco, quantidade: quantidade }],
        total: itemConsumido.preco * quantidade,
        status: 'Em Preparo',
        comandaId: comandaId,
        tipo: 'Consumo Pre-pago'
      };
      setPedidos([...pedidos, registroConsumo]);
    }

    function fecharComandaEGerarVenda(comanda) {
      const vendaFinal = {
        id: comanda.id,
        data: new Date().toISOString(),
        itens: comanda.itensPrePagos.map(i => ({ 
          id: i.id, 
          nome: i.nome, 
          quantidade: i.quantidadeTotal, 
          preco: i.preco
        })), 
        total: comanda.valorInicial, 
        origem: `Comanda - ${comanda.nomeCliente}` 
      };

      setVendas([...vendas, vendaFinal]);
      setComandas(comandas.map(c => c.id === comanda.id ? {...c, status: 'Fechada', dataFechamento: new Date().toISOString()} : c));
      alert(`Comanda ${comanda.nomeCliente} fechada!`);
    }

    function finalizarPedidoEGerarVenda(pedido) {
      if (!confirm(`Finalizar pedido de ${pedido.nomeCliente}?`)) return;

      const novaVenda = {
        id: pedido.id,
        data: new Date().toISOString(),
        itens: pedido.itens,
        total: pedido.total,
        origem: `Pedido - ${pedido.nomeCliente}`
      };

      const novosProdutos = produtos.map(produto => {
        const itemVendido = pedido.itens.find(item => item.id === produto.id);
        if (itemVendido) return { ...produto, estoque: produto.estoque - itemVendido.quantidade };
        return produto;
      });
      
      salvarProdutos(novosProdutos);
      setVendas([...vendas, novaVenda]);
      setPedidos(pedidos.map(p => p.id === pedido.id ? { ...p, status: 'Vendido' } : p));
      
      alert(`Venda registrada! ${currency(pedido.total)}`);
    }

    const totalCarrinho = carrinho.reduce((s,i)=> s + i.preco * i.quantidade, 0);
    
    if(loading) return (
      <div className="min-h-screen flex items-center justify-center bg-gradient-to-br from-cinzaEscuro via-preto to-cinzaEscuro">
        <div className="text-center">
          <div className="text-6xl mb-4">‚è≥</div>
          <div className="text-2xl text-dourado font-bold">Carregando Firebase...</div>
        </div>
      </div>
    );
    
    if(!user) return <Login onLogin={setUser} />;

    return (
      <div className="min-h-screen flex flex-col bg-slate-50">
        <Header user={user} onLogout={()=>setUser(null)} />
        <div className="max-w-7xl mx-auto flex flex-1 w-full overflow-hidden">
          <Sidebar selected={selected} setSelected={setSelected} />
          <main className="flex-1 p-6 overflow-y-auto">
            <div className="flex items-center justify-between mb-6">
              <h1 className="text-2xl font-bold">Painel PDV</h1>
            </div>

            {selected === 'pdv' && (
              <PDVView produtos={produtos} adicionarAoCarrinho={adicionarAoCarrinho} busca={busca} setBusca={setBusca}
                     carrinho={carrinho} alterarQuantidade={alterarQuantidade} removerDoCarrinho={removerDoCarrinho}
                     finalizarVenda={finalizarVenda} totalCarrinho={totalCarrinho} abrirComanda={abrirComanda} />
            )}

            {selected === 'pedidos' && (
              <PedidosView pedidos={pedidos} setPedidos={setPedidos} 
                finalizarPedidoEGerarVenda={finalizarPedidoEGerarVenda}
                comandas={comandas} />
            )}
            
            {selected === 'comandas' && (
              <ComandasView comandas={comandas} 
                fecharComandaEGerarVenda={fecharComandaEGerarVenda}
                consumirItemPrePago={consumirItemPrePago} />
            )}

            {selected === 'produtos' && (
              <ProdutosView produtos={produtos} salvarProdutos={salvarProdutos} />
            )}

            {selected === 'relatorios' && (
              <RelatoriosView vendas={vendas} produtos={produtos} />
            )}

            {selected === 'avancado' && (
              <RelatorioAvancado vendas={vendas} produtos={produtos} />
            )}
          </main>
        </div>
      </div>
    );
  }

  ReactDOM.render(<App />, document.getElementById('root'));
  </script>
</body>

</html>
