<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-C9RLS2SDCJ"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag() { dataLayer.push(arguments); }
    gtag('js', new Date());

    gtag('config', 'G-C9RLS2SDCJ');
  </script>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>PDV - Bar do Gigante (Comandas)</title>

  <script src="https://cdn.tailwindcss.com"></script>
  <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>

  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            dourado: '#D4AF37',
            douradoEscuro: '#B8941F',
            preto: '#1a1a1a',
            cinzaEscuro: '#2d2d2d',
          }
        }
      }
    }
  </script>

  <style>
    /* Estilos existentes... */
    body { -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale; }
    .sidebar-scroll { max-height: calc(100vh - 96px); overflow:auto; }
    ::-webkit-scrollbar { width:10px; height:10px; }
    ::-webkit-scrollbar-thumb { background: linear-gradient(180deg, #D4AF37, #B8941F); border-radius:999px; }
    ::-webkit-scrollbar-track { background: transparent; }

    .logo-bar {
      width: 120px; height: 120px; margin: 0 auto; background: #1a1a1a;
      border-radius: 50%; border: 3px solid #D4AF37;
      display: flex; align-items: center; justify-content: center;
      box-shadow: 0 0 30px rgba(212, 175, 55, 0.5);
    }
    .logo-inner {
      width: 110px; height: 110px; border-radius: 50%; border: 2px solid #ffffff;
      display: flex; flex-direction: column; align-items: center; justify-content: center;
      background: linear-gradient(135deg, #2d2d2d 0%, #1a1a1a 100%); padding: 10px;
    }
    .logo-stars { display: flex; gap: 3px; margin-bottom: 5px; }
    .star { color: #D4AF37; font-size: 11px; }
    .logo-text { text-align: center; }
    .logo-bar-text {
      font-size: 22px; font-weight: bold; color: #D4AF37;
      letter-spacing: 2px; text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
      line-height: 1;
    }
    .logo-do-gigante {
      font-size: 12px; font-weight: bold; color: #ffffff;
      margin-top: 3px; letter-spacing: 1px;
    }

    /* Estilos CORRIGIDOS para impress√£o do relat√≥rio avan√ßado */
    @media print {
        body > div:not(#relatorio-print-area) {
            display: none !important;
        }
        #root {
            width: 100%;
            display: block !important;
        }
        #relatorio-print-area {
            display: block !important;
            width: 100%;
            margin: 0;
            padding: 0;
            box-shadow: none;
        }
        #relatorio-print-area h2 {
            margin-top: 0;
            padding-top: 0;
        }
        .no-print {
            display: none !important;
        }
        /* Garantir que as tabelas sejam leg√≠veis */
        .print-table {
            width: 100%;
            font-size: 10px;
        }
        .print-table th, .print-table td {
            padding: 4px;
        }
    }
  </style>
</head>
<body class="bg-gradient-to-br from-slate-100 via-slate-50 to-slate-100">

  <div id="root"></div>

  <script type="text/babel">
  const { useState, useEffect, useMemo, useRef } = React;

  /**********************
    * CONFIGURA√á√ÉO FIREBASE *
    **********************/
  
  // ‚ö†Ô∏è SUBSTITUA ESTAS CREDENCIAIS PELAS SUAS DO FIREBASE!
  const firebaseConfig = {
    apiKey: "AIzaSyCB5k2sLKlSopQ5xes6e_1ctpXnHA2Pluo",
    authDomain: "bar-do-gigante.firebaseapp.com",
    databaseURL: "https://bar-do-gigante-default-rtdb.firebaseio.com",
    projectId: "bar-do-gigante",
    storageBucket: "bar-do-gigante.firebasestorage.app",
    messagingSenderId: "818575087702",
    appId: "1:818575087702:web:e488390c6f8ec6471b83f7"
  };

  // Inicializa Firebase
  if (!firebase.apps.length) {
    firebase.initializeApp(firebaseConfig);
  }
  const db = firebase.database();

  /**********************
    * Utilit√°rios Firebase *
    **********************/
  const initialProdutosDefault = [
    { id: 1, nome: "Coca-Cola 2L", preco: 8.5, estoque: 50, categoria: "Bebidas" },
    { id: 2, nome: "Cerveja Skol Lata", preco: 3.2, estoque: 120, categoria: "Bebidas" },
    { id: 3, nome: "Cigarro Marlboro", preco: 12.0, estoque: 30, categoria: "Cigarros" },
    { id: 4, nome: "Palito de Dente", preco: 0.5, estoque: 200, categoria: "Diversos" },
    { id: 5, nome: "√Ågua Mineral 500ml", preco: 2.0, estoque: 100, categoria: "Bebidas" },
    { id: 6, nome: "Cacha√ßa 51", preco: 15.0, estoque: 10, categoria: "Destilados" },
    { id: 7, nome: "Salgadinho Elma Chips", preco: 4.5, estoque: 45, categoria: "Petiscos" },
    { id: 8, nome: "Pinga Artesanal", preco: 25.0, estoque: 5, categoria: "Destilados" },
  ];

  function uid(){ return Date.now() + Math.floor(Math.random()*9999); }
  function currency(v){ return 'R$ ' + Number(v||0).toFixed(2).replace('.', ','); }

  // Fun√ß√µes Firebase (substituem localStorage)
  async function storageGet(key, fallback=null){ 
    try {
      const snapshot = await db.ref(key).once('value');
      return snapshot.exists() ? snapshot.val() : fallback;
    } catch(e){ 
      console.error('Erro ao ler Firebase:', e);
      return fallback; 
    }
  }

  async function storageSet(key, value){ 
    try {
      await db.ref(key).set(value);
    } catch(e){
      console.error('Erro ao salvar Firebase:', e);
    }
  }

  function storageWatch(key, callback) {
    db.ref(key).on('value', (snapshot) => {
      if (snapshot.exists()) {
        callback(snapshot.val());
      }
    });
  }

  /**********
    * Login *
    **********/
  const defaultUser = { username: 'admin', password: '1234' };

  function Login({onLogin}){
    const [u, setU] = useState('');
    const [p, setP] = useState('');
    const [err, setErr] = useState('');

    function submit(e){
      e.preventDefault();
      if(u === defaultUser.username && p === defaultUser.password){
        onLogin({username: u});
      } else {
        setErr('Usu√°rio ou senha inv√°lidos');
      }
    }

    return (
      <div className="min-h-screen flex items-center justify-center p-6 bg-gradient-to-br from-cinzaEscuro via-preto to-cinzaEscuro">
        <div className="max-w-4xl w-full grid grid-cols-1 md:grid-cols-2 gap-8 items-center">
          <div className="hidden md:flex flex-col items-center justify-center rounded-2xl p-8 bg-cinzaEscuro shadow-xl border-2 border-dourado">
            <div className="logo-bar mb-4">
              <div className="logo-inner">
                <div className="logo-stars">
                  <span className="star">‚òÖ</span>
                  <span className="star">‚òÖ</span>
                  <span className="star">‚òÖ</span>
                  <span className="star">‚òÖ</span>
                  <span className="star">‚òÖ</span>
                </div>
                <div className="logo-text">
                  <div className="logo-bar-text">BAR</div>
                  <div className="logo-do-gigante">DO GIGANTE</div>
                </div>
              </div>
            </div>
            <h1 className="text-3xl font-extrabold text-dourado">Bar do Gigante</h1>
            <p className="mt-2 text-gray-300">PDV moderno e funcional</p>
            <div className="mt-6 text-sm text-gray-400">Dica: usu√°rio <b className="text-dourado">admin</b> / senha <b className="text-dourado">1234</b></div>
          </div>

          <form onSubmit={submit} className="bg-cinzaEscuro border-2 border-dourado rounded-2xl p-6 shadow-lg">
            <div className="flex items-center justify-between mb-6">
              <div>
                <h2 className="text-2xl font-bold text-dourado">Entrar</h2>
                <p className="text-sm text-gray-300">Acesse o sistema PDV</p>
              </div>
              <div className="text-2xl">üîí</div>
            </div>

            <label className="block mb-4">
              <span className="text-sm text-gray-300">Usu√°rio</span>
              <input className="mt-1 block w-full p-3 border border-dourado bg-preto text-white rounded-xl focus:outline-none focus:ring-2 focus:ring-dourado transition" value={u} onChange={e=>setU(e.target.value)} required />
            </label>

            <label className="block mb-4">
              <span className="text-sm text-gray-300">Senha</span>
              <input type="password" className="mt-1 block w-full p-3 border border-dourado bg-preto text-white rounded-xl focus:outline-none focus:ring-2 focus:ring-dourado transition" value={p} onChange={e=>setP(e.target.value)} required />
            </label>

            {err && <div className="text-red-400 mb-3">{err}</div>}

            <button className="w-full py-3 rounded-xl font-bold bg-gradient-to-r from-dourado to-douradoEscuro text-preto shadow-md hover:shadow-lg transform hover:-translate-y-0.5 transition">Entrar</button>
          </form>
        </div>
      </div>
    );
  }

  /****************
    * Header, Side *
    ****************/
  function Header({user, onLogout}){
    return (
      <header className="bg-white shadow sticky top-0 z-30">
        <div className="max-w-7xl mx-auto px-4 py-3 flex items-center justify-between">
          <div className="flex items-center gap-4">
            <div className="text-3xl">üçª</div>
            <div>
              <div className="text-lg font-bold bg-clip-text text-transparent bg-gradient-to-r from-indigo-600 to-purple-600">Bar do Gigante</div>
              <div className="text-xs text-gray-500 hidden sm:block">Sistema PDV (Firebase)</div>
            </div>
          </div>

          <div className="flex items-center gap-4">
            <div className="flex items-center gap-2 bg-gray-50 px-3 py-1 rounded-full shadow-sm">
              <div className="text-sm text-gray-700">üë§ {user?.username}</div>
            </div>
            <button onClick={onLogout} className="px-3 py-1 rounded-lg border hover:bg-gray-50 transition">Sair</button>
          </div>
        </div>
      </header>
    );
  }

  function Sidebar({selected, setSelected}){
    const itens = [
      { key:'pdv', label:'üõí PDV' },
      { key:'pedidos', label:'üîî Pedidos' },
      { key:'comandas', label:'üí≥ Comandas Abertas' },
      { key:'produtos', label:'üì¶ Produtos' },
      { key:'relatorios', label:'üìä Relat√≥rios' },
      { key:'avancado', label:'üìà Relat√≥rio Avan√ßado' }
    ];
    return (
      <aside className="w-64 bg-white border-r hidden md:block">
        <div className="p-4 sidebar-scroll">
          {itens.map(i=>(
            <button key={i.key} onClick={()=>setSelected(i.key)}
              className={`flex items-center gap-3 w-full text-left px-3 py-3 rounded-xl my-1 font-medium transition ${selected===i.key ? 'bg-gradient-to-r from-indigo-600 to-purple-600 text-white shadow-lg' : 'hover:bg-indigo-50'}`}>
              <span>{i.label}</span>
            </button>
          ))}
        </div>
      </aside>
    );
  }

  /*********************
    * PDV & Comandas *
    *********************/
  function PDVView({produtos, adicionarAoCarrinho, busca, setBusca, carrinho, alterarQuantidade, removerDoCarrinho, finalizarVenda, totalCarrinho, abrirComanda}){
    const produtosFiltrados = produtos.filter(p => p.nome.toLowerCase().includes(busca.toLowerCase()) || p.categoria.toLowerCase().includes(busca.toLowerCase()));

    return (
      <div className="space-y-4">
        <div className="bg-white p-4 rounded-2xl shadow flex gap-3 items-center">
          <input value={busca} onChange={e=>setBusca(e.target.value)} placeholder="Pesquisar produto ou categoria" className="flex-1 p-3 border rounded-xl focus:ring-2 focus:ring-indigo-200 transition" />
        </div>

        <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
          <div className="lg:col-span-2">
            <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">
              {produtosFiltrados.map(produto => (
                <div key={produto.id}
                      onClick={()=>adicionarAoCarrinho(produto)}
                      className="p-4 rounded-2xl border cursor-pointer shadow-sm hover:shadow-lg transform hover:-translate-y-1 transition bg-white">
                  <div className="flex items-start justify-between gap-3">
                    <div>
                      <div className="text-sm text-gray-500">{produto.categoria}</div>
                      <div className="font-semibold text-lg mt-1">{produto.nome}</div>
                    </div>
                    <div className="text-right">
                      <div className="text-green-600 font-bold text-lg">{currency(produto.preco)}</div>
                      <div className="text-xs mt-2">
                        {produto.estoque <= 10 ? (
                          <span className="inline-flex items-center gap-2 px-2 py-1 rounded-full text-red-700 bg-red-50 text-xs font-semibold">‚ö†Ô∏è {produto.estoque}</span>
                        ) : (
                          <span className="inline-flex items-center gap-2 px-2 py-1 rounded-full text-gray-700 bg-gray-50 text-xs">üì¶ {produto.estoque}</span>
                        )}
                      </div>
                    </div>
                  </div>
                </div>
              ))}
            </div>
          </div>

          <div className="bg-white p-4 rounded-2xl shadow h-full flex flex-col">
            <h3 className="font-bold text-lg flex items-center gap-2">üßæ Carrinho</h3>

            <div className="mt-3 flex-1 max-h-96 overflow-y-auto space-y-3">
              {carrinho.map(item=>(
                <div key={item.id} className="p-3 border rounded-lg">
                  <div className="flex items-start justify-between">
                    <div>
                      <div className="font-medium">{item.nome}</div>
                      <div className="text-xs text-gray-500">{item.categoria}</div>
                    </div>
                    <div className="text-right">
                      <div className="font-semibold text-green-600">{currency(item.preco * item.quantidade)}</div>
                    </div>
                  </div>

                  <div className="mt-3 flex items-center gap-2">
                    <button onClick={()=>alterarQuantidade(item.id, item.quantidade - 1)} className="px-3 py-1 border rounded-lg hover:bg-gray-50 transition">‚àí</button>
                    <div className="px-3">{item.quantidade}</div>
                    <button onClick={()=>alterarQuantidade(item.id, item.quantidade + 1)} className="px-3 py-1 border rounded-lg hover:bg-gray-50 transition">+</button>
                    <button onClick={()=>removerDoCarrinho(item.id)} className="ml-auto text-red-600 hover:underline">Remover</button>
                  </div>
                </div>
              ))}

              {carrinho.length===0 && <div className="text-gray-500 text-center py-6">Carrinho vazio</div>}
            </div>

            <div className="mt-4 border-t pt-3">
              <div className="flex items-center justify-between font-bold text-lg mb-3">
                <div>Total</div>
                <div className="text-green-600">{currency(totalCarrinho)}</div>
              </div>
              
              <button onClick={abrirComanda} 
                      disabled={carrinho.length === 0}
                      className="w-full py-3 mb-2 rounded-xl font-bold bg-indigo-500 text-white shadow hover:shadow-lg transition disabled:opacity-50">
                Abrir Comanda
              </button>

              <button onClick={finalizarVenda} 
                      disabled={carrinho.length === 0}
                      className="w-full py-3 rounded-xl font-bold bg-gradient-to-r from-green-500 to-teal-400 text-white shadow hover:shadow-lg transition disabled:opacity-50">
                Finalizar Venda Direta
              </button>
            </div>
          </div>
        </div>
      </div>
    );
  }
  
  function ComandasView({ comandas, fecharComandaEGerarVenda, consumirItemPrePago }){
    const comandasAbertas = comandas.filter(c => c.status === 'Aberta');

    function fecharComanda(comanda) {
      const itensRestantes = comanda.itensPrePagos.reduce((count, item) => count + item.quantidadeDisponivel, 0);
      if (itensRestantes > 0) {
        if (!confirm(`ATEN√á√ÉO! ${itensRestantes} itens dispon√≠veis ser√£o perdidos. Continuar?`)) return;
      }
      if (confirm(`Fechar Comanda ${comanda.nomeCliente}?`)) {
        fecharComandaEGerarVenda(comanda);
      }
    }

    function consumirItem(comandaId, itemId, quantidade = 1) {
      const comanda = comandas.find(c => c.id === comandaId);
      const item = comanda.itensPrePagos.find(i => i.id === itemId);
      if (item.quantidadeDisponivel < quantidade) {
        alert(`Apenas ${item.quantidadeDisponivel} dispon√≠veis.`);
        return;
      }
      if (confirm(`Confirmar consumo de ${quantidade}x ${item.nome}?`)) {
        consumirItemPrePago(comandaId, itemId, quantidade);
      }
    }

    return (
      <div className="space-y-6">
        <h2 className="text-3xl font-extrabold text-gray-800 border-b pb-2 flex items-center gap-3">
          <span className="text-4xl">üí≥</span> Comandas Abertas
        </h2>

        <div className="grid grid-cols-1 lg:grid-cols-2 xl:grid-cols-3 gap-6">
          {comandasAbertas.map(c => (
            <div key={c.id} className="p-4 rounded-2xl shadow-lg border-2 border-indigo-500 bg-white">
              <h3 className="font-bold text-xl text-indigo-700">{c.nomeCliente}</h3>
              <p className="text-sm text-gray-600 font-semibold mb-3">Mesa: <span className="text-red-500">{c.mesaFixa}</span></p>
              <p className="text-xs text-gray-500">Pago: {currency(c.valorInicial)}</p>
              
              <div className="border-t pt-2 mt-2">
                <h4 className="font-bold text-lg mb-2 text-purple-600">Itens:</h4>
                {c.itensPrePagos.map(item => (
                  <div key={item.id} className="flex justify-between items-center py-2 border-b">
                    <span className="font-medium">{item.nome}</span>
                    <div className="flex items-center gap-2">
                      <span className="font-bold text-xl text-green-600">{item.quantidadeDisponivel}</span>
                      {item.quantidadeDisponivel > 0 ? (
                        <button 
                          onClick={() => consumirItem(c.id, item.id)}
                          className="px-3 py-1 bg-green-500 text-white rounded-lg text-sm hover:bg-green-600"
                        >
                          Consumir
                        </button>
                      ) : (
                        <span className="text-xs text-gray-400">Esgotado</span>
                      )}
                    </div>
                  </div>
                ))}
              </div>
              
              <button 
                onClick={() => fecharComanda(c)}
                className="w-full py-2 mt-4 bg-red-500 text-white rounded-lg hover:bg-red-600 transition font-semibold"
              >
                Fechar Comanda
              </button>
            </div>
          ))}

          {comandasAbertas.length === 0 && (
            <div className="md:col-span-3 text-center text-gray-500 p-8 border rounded-xl bg-gray-50">Nenhuma comanda ativa</div>
          )}
        </div>
      </div>
    );
  }

  function PedidosView({ pedidos, setPedidos, finalizarPedidoEGerarVenda, comandas, limparPedidosFinalizados }) {
    function alterarStatus(id, novoStatus) {
      const novosPedidos = pedidos.map(p => p.id === id ? { ...p, status: novoStatus } : p);
      setPedidos(novosPedidos);
    }
    
    const pedidosDeVenda = pedidos.filter(p => p.tipo !== 'Consumo Pre-pago' && p.status !== 'Vendido');
    const pedidosConsumo = pedidos.filter(p => p.tipo === 'Consumo Pre-pago');
    
    const pedidosPendentes = pedidosDeVenda.filter(p => p.status === 'Pendente');
    const pedidosEmPreparo = pedidosDeVenda.filter(p => p.status === 'Em Preparo');
    const pedidosConsumoAtivos = pedidosConsumo.filter(p => p.status === 'Em Preparo');
    const listaEmPreparo = pedidosEmPreparo.concat(pedidosConsumoAtivos);
    
    const comandaMap = useMemo(() => {
      return comandas.reduce((map, c) => {
        map[c.id] = c;
        return map;
      }, {});
    }, [comandas]);

    function marcarConsumoComoEntregue(pedido) {
      if (!confirm(`Marcar como entregue?`)) return;
      const novosPedidos = pedidos.map(p => p.id === pedido.id ? { ...p, status: 'Consumo Entregue' } : p);
      setPedidos(novosPedidos);
    }
    
    const pedidosFinalizados = pedidos.filter(p => p.status === 'Vendido' || p.status === 'Consumo Entregue');

    return (
      <div className="space-y-6">
        <h2 className="text-3xl font-extrabold text-gray-800 border-b pb-2 flex items-center gap-3">
          <span className="text-4xl">üîî</span> Gest√£o de Pedidos
        </h2>
        
        <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
          <div className="p-4 rounded-2xl shadow border border-red-200 bg-red-50">
            <h3 className="font-bold text-xl mb-4 text-red-700">NOVOS - {pedidosPendentes.length}</h3>
            <div className="space-y-4 max-h-[70vh] overflow-y-auto">
              {pedidosPendentes.map(p => (
                <div key={p.id} className="p-3 bg-white rounded-xl shadow-md border border-red-300">
                  <div className="font-bold text-lg text-red-600">{p.nomeCliente}</div>
                  <ul className="list-disc list-inside text-sm mb-3 ml-3">
                    {p.itens.map(it => <li key={it.id}>{it.quantidade}x {it.nome}</li>)}
                  </ul>
                  <button onClick={() => alterarStatus(p.id, 'Em Preparo')} className="w-full mt-3 py-2 bg-indigo-500 text-white rounded-lg hover:bg-indigo-600">Iniciar</button>
                </div>
              ))}
              {pedidosPendentes.length === 0 && <div className="text-gray-500 text-center py-6">Nenhum novo</div>}
            </div>
          </div>

          <div className="p-4 rounded-2xl shadow border border-yellow-200 bg-yellow-50">
            <h3 className="font-bold text-xl mb-4 text-yellow-700">EM PREPARO - {listaEmPreparo.length}</h3>
            <div className="space-y-4 max-h-[70vh] overflow-y-auto">
              {listaEmPreparo.map(p => {
                const isConsumo = p.tipo === 'Consumo Pre-pago';
                const comandaInfo = comandaMap[p.comandaId];
                
                return (
                  <div key={p.id} className={`p-3 bg-white rounded-xl shadow-md border ${isConsumo ? 'border-purple-300' : 'border-yellow-300'}`}>
                    <div className={`font-bold text-xl ${isConsumo ? 'text-purple-600' : 'text-yellow-600'}`}>
                      {p.nomeCliente}
                    </div>
                    <ul className="list-disc list-inside text-sm mb-3 ml-3">
                      {p.itens.map(it => <li key={it.id}>{it.quantidade}x {it.nome}</li>)}
                    </ul>
                    <div className="font-bold text-lg">{currency(p.total)}</div>
                    
                    {isConsumo ? (
                      <button 
                        onClick={() => marcarConsumoComoEntregue(p)} 
                        className="w-full mt-3 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700"
                      >
                        Marcar Entregue
                      </button>
                    ) : (
                      <button 
                        onClick={() => finalizarPedidoEGerarVenda(p)} 
                        className="w-full mt-3 py-2 bg-green-500 text-white rounded-lg hover:bg-green-600"
                      >
                        Finalizar Venda
                      </button>
                    )}
                  </div>
                );
              })}
              {listaEmPreparo.length === 0 && <div className="text-gray-500 text-center py-6">Nenhum em preparo</div>}
            </div>
          </div>
          
          <div className="p-4 rounded-2xl shadow border border-green-200 bg-green-50">
            <h3 className="font-bold text-xl mb-4 text-green-700">
                FINALIZADOS - {pedidosFinalizados.length}
                {pedidosFinalizados.length > 0 && (
                    <button 
                        onClick={limparPedidosFinalizados}
                        className="text-xs text-red-600 ml-2 hover:underline"
                        title="Apaga permanentemente os pedidos com status 'Vendido' ou 'Consumo Entregue'"
                    >
                        [Limpar]
                    </button>
                )}
            </h3>
            <div className="space-y-4 max-h-[70vh] overflow-y-auto">
              {pedidosFinalizados.slice(0, 5).map(p => ( 
                <div key={p.id} className="p-3 bg-white rounded-xl shadow-md border border-green-300">
                  <div className="font-bold text-lg text-green-600">{p.nomeCliente}</div>
                  <div className="text-right font-bold text-lg">{currency(p.total)}</div>
                </div>
              ))}
              {pedidosFinalizados.length > 5 && (
                  <div className="text-center text-gray-500 text-sm">...e mais {pedidosFinalizados.length - 5} pedidos.</div>
              )}
            </div>
          </div>
        </div>
      </div>
    );
  }
  
  function ProdutosView({produtos, salvarProdutos}){
    const [form, setForm] = useState({ id:null, nome:'', preco:'', estoque:'', categoria:'' });

    function submit(e){
      e.preventDefault();
      if(!form.nome || !form.preco || !form.estoque) return alert('Preencha os campos obrigat√≥rios');
      const novo = { ...form, preco: Number(form.preco), estoque: Number(form.estoque), id: form.id || uid() };
      let novos;
      if(form.id) novos = produtos.map(p=> p.id===form.id ? novo : p);
      else novos = [...produtos, novo];
      salvarProdutos(novos);
      setForm({ id:null, nome:'', preco:'', estoque:'', categoria:'' });
    }

    function editar(p){ setForm({...p, preco: String(p.preco), estoque: String(p.estoque)}); }
    function excluir(p){ if(!confirm(`Excluir ${p.nome}?`)) return; salvarProdutos(produtos.filter(x=>x.id!==p.id)); }

    return (
      <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
        <div className="bg-white p-4 rounded-2xl shadow">
          <h3 className="font-bold mb-3">{form.id ? 'Editar' : 'Novo'} Produto</h3>
          <form onSubmit={submit} className="space-y-3">
            <input value={form.nome} onChange={e=>setForm({...form, nome:e.target.value})} placeholder="Nome" className="w-full p-3 border rounded-xl" required />
            <input value={form.preco} onChange={e=>setForm({...form, preco:e.target.value})} placeholder="Pre√ßo" type="number" step="0.01" className="w-full p-3 border rounded-xl" required />
            <input value={form.estoque} onChange={e=>setForm({...form, estoque:e.target.value})} placeholder="Estoque" type="number" className="w-full p-3 border rounded-xl" required />
            <input value={form.categoria} onChange={e=>setForm({...form, categoria:e.target.value})} placeholder="Categoria" className="w-full p-3 border rounded-xl" />

            <div className="flex gap-3">
              <button className="flex-1 py-3 bg-gradient-to-r from-indigo-600 to-purple-600 text-white rounded-xl font-semibold shadow">{form.id ? 'Atualizar' : 'Adicionar'}</button>
              {form.id && <button type="button" onClick={()=>setForm({ id:null, nome:'', preco:'', estoque:'', categoria:'' })} className="py-3 px-4 border rounded-xl">Cancelar</button>}
            </div>
          </form>
        </div>

        <div className="lg:col-span-2 bg-white p-4 rounded-2xl shadow">
          <h3 className="font-bold mb-3">Produtos</h3>
          <div className="overflow-x-auto">
            <table className="w-full text-sm">
              <thead className="bg-gradient-to-r from-indigo-50 to-purple-50">
                <tr>
                  <th className="p-3 text-left">Produto</th>
                  <th className="p-3 text-left">Categoria</th>
                  <th className="p-3 text-right">Pre√ßo</th>
                  <th className="p-3 text-right">Estoque</th>
                  <th className="p-3 text-center">A√ß√µes</th>
                </tr>
              </thead>
              <tbody>
                {produtos.map(p=>(
                  <tr key={p.id} className="border-b hover:bg-gray-50">
                    <td className="p-3">{p.nome}</td>
                    <td className="p-3">{p.categoria}</td>
                    <td className="p-3 text-right">{currency(p.preco)}</td>
                    <td className={`p-3 text-right ${p.estoque<=10 ? 'text-red-600 font-bold' : ''}`}>{p.estoque}</td>
                    <td className="p-3 text-center">
                      <div className="flex items-center justify-center gap-3">
                        <button onClick={()=>editar(p)} className="text-indigo-600 hover:underline">Editar</button>
                        <button onClick={()=>excluir(p)} className="text-red-600 hover:underline">Excluir</button>
                      </div>
                    </td>
                  </tr>
                ))}
              </tbody>
            </table>
          </div>
        </div>
      </div>
    );
  }
  
  function RelatoriosView({ vendas, produtos }) {
    const areaRef = useRef(null);
    const barRef = useRef(null);
    const pieRef = useRef(null); 
    
    const CHART_COLORS = [
        '#8b5cf6', '#3b82f6', '#10b981', '#f59e0b', '#ef4444', '#a855f7',
        '#4ade80', '#fbbf24', '#f87171', '#c084fc'
    ];
    
    // UTILITY: Mapear produtos para encontrar o custo (preco) original
    const productMap = useMemo(() => {
        return produtos.reduce((map, p) => {
            map[p.id] = p;
            return map;
        }, {});
    }, [produtos]);

    // Obt√©m a data de hoje no formato YYYY-MM-DD
    const today = new Date().toISOString().split('T')[0];

    // C√ÅLCULOS
    
    // 1. Receita e Custo por dia (para Gr√°fico e Tabela Di√°ria)
    const dailySeries = useMemo(() => {
        const revenueMap = {};
        const costMap = {}; 

        vendas.forEach(v => {
            const day = v.data.split('T')[0];
            const vendaTotal = v.total;
            let custoTotalVenda = 0;

            v.itens.forEach(it => {
                // Simula√ß√£o de Custo (CMV)
                const precoUnitario = it.preco; 
                custoTotalVenda += precoUnitario * it.quantidade;
            });

            revenueMap[day] = (revenueMap[day] || 0) + vendaTotal;
            costMap[day] = (costMap[day] || 0) + custoTotalVenda;
        });

        const allDates = [...new Set([...Object.keys(revenueMap), ...Object.keys(costMap)])];
        allDates.sort((a, b) => a.localeCompare(b));

        return allDates.map(date => ({
            date: date,
            revenue: revenueMap[date] || 0,
            cost: costMap[date] || 0,
            lucro: (revenueMap[date] || 0) - (costMap[date] || 0)
        }));
    }, [vendas]);


    // 2. Top Produtos (para Gr√°fico de Barras)
    const topProdutosData = useMemo(() => {
      const vendaMap = {};
      let totalUnidadesVendidas = 0; 

      vendas.forEach(v => {
        v.itens.forEach(it => {
          vendaMap[it.id] = vendaMap[it.id] || { id: it.id, nome: it.nome, quantidade: 0, total: 0 };
          vendaMap[it.id].quantidade += it.quantidade;
          vendaMap[it.id].total += it.preco * it.quantidade;
          totalUnidadesVendidas += it.quantidade; 
        });
      });

      const list = Object.values(vendaMap)
        .sort((a, b) => b.quantidade - a.quantidade)
        .slice(0, 6);
        
      return { list, totalUnidades: totalUnidadesVendidas };
    }, [vendas]);
    
    // 3. Distribui√ß√£o por Categoria (para Gr√°fico de Pizza)
    const categoriaDistribuicao = useMemo(() => {
        const catMap = {};
        let totalReceita = 0;

        vendas.forEach(v => {
            v.itens.forEach(it => {
                const produtoOriginal = productMap[it.id] || { categoria: 'Outros' };
                const categoria = produtoOriginal.categoria || 'Outros';
                const receitaItem = it.preco * it.quantidade;

                catMap[categoria] = (catMap[categoria] || 0) + receitaItem;
                totalReceita += receitaItem;
            });
        });
        
        const labels = Object.keys(catMap);
        const data = Object.values(catMap);

        return { labels, data, total: totalReceita };
    }, [vendas, productMap]);
    
    // 4. Resumo Simplificado para Cards
    const resumoStats = useMemo(() => {
        const receitaTotal = categoriaDistribuicao.total;
        
        // Calcular a Receita do Dia Atual
        const receitaDoDia = dailySeries.find(day => day.date === today)?.revenue || 0;

        return { 
            receitaTotal, 
            receitaDoDia
        };
    }, [categoriaDistribuicao.total, dailySeries, today]);


    // EFEITOS (RENDERIZA√á√ÉO DOS GR√ÅFICOS)
    useEffect(() => {
      // Destruir gr√°ficos existentes
      const destroyChart = (ref) => { if (ref.current && ref.current._chart) { try { ref.current._chart.destroy(); } catch { } } };
      destroyChart(areaRef);
      destroyChart(barRef);
      destroyChart(pieRef); 

      // 1. Gr√°fico de Receita e Custo por Dia (Linha Dupla)
      if (areaRef.current) {
        if (dailySeries.length > 0) {
          areaRef.current.style.display = 'block';
          const ctx = areaRef.current.getContext('2d');
          const labels = dailySeries.map(s => s.date.substring(5));
          const receitaData = dailySeries.map(s => s.revenue);
          const custoData = dailySeries.map(s => s.cost); 

          areaRef.current._chart = new Chart(ctx, {
            type: 'line',
            data: { 
                labels, 
                datasets: [
                    { 
                        label: 'Receita (R$)', 
                        data: receitaData, 
                        fill: false, 
                        tension: 0.3, 
                        borderColor: CHART_COLORS[0], // Roxo
                        backgroundColor: 'rgba(139, 92, 246, 0.12)', 
                    },
                    { 
                        label: 'Custo/Gasto (R$)', 
                        data: custoData, 
                        fill: false, 
                        tension: 0.3, 
                        borderColor: CHART_COLORS[4], // Vermelho
                        backgroundColor: 'rgba(239, 68, 68, 0.12)', 
                    }
                ] 
            },
            options: { responsive: true, maintainAspectRatio: false }
          });
        } else {
          areaRef.current.style.display = 'none';
        }
      }

      // 2. Gr√°fico de Top Produtos (Barras)
      if (barRef.current) {
        if (topProdutosData.list.length > 0) {
          barRef.current.style.display = 'block';
          const ctx = barRef.current.getContext('2d');
          const labels = topProdutosData.list.map(t => t.nome);
          const data = topProdutosData.list.map(t => t.quantidade);
          barRef.current._chart = new Chart(ctx, { 
            type: 'bar', 
            data: { labels, datasets: [{ label:'Quantidade Vendida', data, backgroundColor: CHART_COLORS[0] }] }, 
            options: { indexAxis:'y', responsive:true, maintainAspectRatio:false, plugins: { legend: { display: false } } } 
          });
        } else {
           barRef.current.style.display = 'none';
        }
      }
      
      // 3. Gr√°fico de Pizza (Distribui√ß√£o por Categoria)
      if (pieRef.current) {
        if (categoriaDistribuicao.data.length > 0) {
            pieRef.current.style.display = 'block';
            const ctx = pieRef.current.getContext('2d');
            pieRef.current._chart = new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: categoriaDistribuicao.labels,
                    datasets: [{
                        data: categoriaDistribuicao.data,
                        backgroundColor: CHART_COLORS.slice(0, categoriaDistribuicao.labels.length),
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'right' }
                    }
                }
            });
        } else {
            pieRef.current.style.display = 'none';
        }
      }
    }, [dailySeries, topProdutosData.list, categoriaDistribuicao]);

    return (
      <div className="space-y-6">
        <h2 className="text-3xl font-extrabold text-gray-800 border-b pb-2">üìä Relat√≥rios Simples</h2>
        
        {/* RESUMO R√ÅPIDO SIMPLIFICADO */}
        <div className="grid grid-cols-1 md:grid-cols-4 gap-4">
            <div className="bg-white p-4 rounded-2xl shadow border border-green-200 col-span-2">
                <div className="text-sm text-gray-500">Receita Total Acumulada</div>
                <div className="font-bold text-3xl text-green-600">{currency(resumoStats.receitaTotal)}</div>
            </div>
            <div className="bg-white p-4 rounded-2xl shadow border border-indigo-200 col-span-2">
                <div className="text-sm text-gray-500">Receita do Dia ({today.split('-').reverse().join('/')})</div>
                <div className="font-bold text-3xl text-indigo-600">{currency(resumoStats.receitaDoDia)}</div>
            </div>
        </div>

        <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
          <div className="lg:col-span-2 bg-white p-4 rounded-2xl shadow">
            <h4 className="font-bold mb-2">Receita vs. Custo (CMV) por dia (Gr√°fico)</h4>
            <div style={{ height: 300, position: 'relative' }}>
              <canvas ref={areaRef}></canvas>
              {dailySeries.length === 0 && <div className="text-gray-500 text-center py-10 absolute inset-0 flex items-center justify-center">Sem dados de venda para o gr√°fico de linha.</div>}
            </div>
          </div>

          <div className="bg-white p-4 rounded-2xl shadow">
            <h4 className="font-bold mb-3">Distribui√ß√£o por Categoria (Gr√°fico de Pizza)</h4>
            <div style={{ height: 300, position: 'relative' }}>
                <canvas ref={pieRef}></canvas>
                {categoriaDistribuicao.data.length === 0 && <div className="text-gray-500 text-center py-10 absolute inset-0 flex items-center justify-center">Sem dados de categoria.</div>}
            </div>
          </div>
          
          {/* TABELA DE DETALHE DI√ÅRIO MANTIDA */}
          <div className="lg:col-span-3 bg-white p-4 rounded-2xl shadow">
            <h4 className="font-bold mb-3">Detalhe Di√°rio: Receita, Custo/Gasto (CMV) e Lucro Bruto</h4>
            <div className="overflow-x-auto max-h-96">
              <table className="w-full text-sm">
                <thead className="bg-gray-100 sticky top-0">
                  <tr>
                    <th className="p-3 text-left">Data</th>
                    <th className="p-3 text-right text-green-600">Receita</th>
                    <th className="p-3 text-right text-red-600">Custo/Gasto (CMV)</th>
                    <th className="p-3 text-right text-purple-600">Lucro Bruto</th>
                  </tr>
                </thead>
                <tbody>
                  {dailySeries.map(day => (
                    <tr key={day.date} className="border-b hover:bg-gray-50">
                      <td className="p-3 font-medium">{day.date.split('-').reverse().join('/')}</td>
                      <td className="p-3 text-right">{currency(day.revenue)}</td>
                      <td className="p-3 text-right">{currency(day.cost)}</td>
                      <td className={`p-3 text-right font-bold ${day.lucro > 0 ? 'text-purple-600' : 'text-gray-500'}`}>{currency(day.lucro)}</td>
                    </tr>
                  ))}
                  {dailySeries.length === 0 && (
                      <tr><td colSpan="4" className="text-center text-gray-500 py-6">Sem dados de movimenta√ß√£o di√°ria.</td></tr>
                  )}
                </tbody>
              </table>
            </div>
          </div>
          
          <div className="lg:col-span-3 bg-white p-4 rounded-2xl shadow">
            <h4 className="font-bold mb-3">Top 6 Produtos Mais Vendidos (Quantidade)</h4>
            <div style={{ height: 300, position: 'relative' }}>
              <canvas ref={barRef}></canvas>
              {topProdutosData.list.length === 0 && <div className="text-gray-500 text-center py-10 absolute inset-0 flex items-center justify-center">Sem dados de top produtos.</div>}
            </div>
          </div>
        </div>
      </div>
    );
  }

  function RelatorioAvancado({ vendas, produtos, comandas, limparDadosPorData }) { 
    const [from, setFrom] = useState('');
    const [to, setTo] = useState('');
    const [filtroCategoria, setFiltroCategoria] = useState(''); 
    const [filtroPagamento, setFiltroPagamento] = useState(''); 
    const printAreaRef = useRef(null);
    
    // Lista de categorias √∫nicas para o filtro
    const categorias = useMemo(() => {
        const unique = new Set(produtos.map(p => p.categoria).filter(c => c));
        return ['Todas as Categorias', ...Array.from(unique).sort()];
    }, [produtos]);
    
    const meiosPagamento = [
        'Todos os Pagamentos',
        'PDV Balc√£o (Venda Direta)',
        'Comanda (Pr√©-pago)'
    ];

    const vendasFiltradas = useMemo(() => {
      let filtered = vendas;
      
      // 1. Filtrar por Data
      if (from) filtered = filtered.filter(v => v.data.split('T')[0] >= from);
      if (to) filtered = filtered.filter(v => v.data.split('T')[0] <= to);

      // 2. Filtrar por Meio de Pagamento
      if (filtroPagamento === 'PDV Balc√£o (Venda Direta)') {
          filtered = filtered.filter(v => v.origem === 'PDV Balc√£o');
      } else if (filtroPagamento.includes('Comanda')) {
          filtered = filtered.filter(v => v.origem.startsWith('Comanda'));
      }
      
      // 3. Filtrar por Categoria
      if (filtroCategoria && filtroCategoria !== 'Todas as Categorias') {
          filtered = filtered.filter(venda => {
              return venda.itens.some(itemVendido => {
                  const produto = produtos.find(p => p.id === itemVendido.id);
                  return produto && produto.categoria === filtroCategoria;
              });
          });
      }
      
      return filtered;
    }, [vendas, from, to, filtroPagamento, filtroCategoria, produtos]);

    const stats = useMemo(() => {
      const totalVendas = vendasFiltradas.length;
      const receitaTotal = vendasFiltradas.reduce((acc, v) => acc + v.total, 0);
      const ticketMedio = totalVendas > 0 ? receitaTotal / totalVendas : 0;

      const productsSold = {};
      vendasFiltradas.forEach(v => {
        v.itens.forEach(item => {
          productsSold[item.id] = productsSold[item.id] || { nome: item.nome, quantidade: 0, total: 0 };
          productsSold[item.id].quantidade += item.quantidade;
          productsSold[item.id].total += item.preco * item.quantidade;
        });
      });

      const topProdutos = Object.values(productsSold).sort((a, b) => b.quantidade - a.quantidade).slice(0, 10);
      const vendasPorOrigem = vendasFiltradas.reduce((acc, v) => {
          acc[v.origem] = (acc[v.origem] || 0) + v.total;
          return acc;
      }, {});

      return { totalVendas, receitaTotal, ticketMedio, topProdutos, vendasPorOrigem };
    }, [vendasFiltradas]);
    
    // Fun√ß√£o de impress√£o
    const handlePrint = () => {
        window.print();
    };
    
    // Fun√ß√£o para formatar data e hora
    const formatDateTime = (isoString) => {
        if (!isoString) return '';
        const date = new Date(isoString);
        return date.toLocaleDateString('pt-BR') + ' ' + date.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' });
    };
    
    // Fun√ßao de Limpeza de dados por data
    const handleLimparDados = () => {
        if (!to) {
            alert("Por favor, selecione a 'Data Final' para limpar os dados.");
            return;
        }
        
        if (!confirm(`ATEN√á√ÉO! Esta a√ß√£o apagar√° permanentemente TODAS AS VENDAS, PEDIDOS FINALIZADOS e COMANDAS FECHADAS AT√â a data ${to.split('-').reverse().join('/')}. Continuar?`)) {
            return;
        }
        
        limparDadosPorData(to);
    };

    return (
      <div className="space-y-6">
        <h2 className="text-3xl font-extrabold text-gray-800 border-b pb-2">üìà Relat√≥rio Avan√ßado</h2>

        <div className="bg-white border p-4 rounded-2xl shadow no-print">
          <h3 className="font-bold mb-3">Filtros e A√ß√µes</h3>
          <div className="grid grid-cols-1 md:grid-cols-6 gap-4">
            <label className="block col-span-1">
              <span className="text-sm text-gray-500">Data Inicial</span>
              <input type="date" value={from} onChange={e => setFrom(e.target.value)} className="mt-1 block w-full p-3 border rounded-xl" />
            </label>
            <label className="block col-span-1">
              <span className="text-sm text-gray-500">Data Final</span>
              <input type="date" value={to} onChange={e => setTo(e.target.value)} className="mt-1 block w-full p-3 border rounded-xl" />
            </label>
            
            <label className="block col-span-1">
              <span className="text-sm text-gray-500">Meio de Pagamento</span>
              <select value={filtroPagamento} onChange={e => setFiltroPagamento(e.target.value)} className="mt-1 block w-full p-3 border rounded-xl bg-white">
                {meiosPagamento.map(m => <option key={m} value={m}>{m}</option>)}
              </select>
            </label>
            
            <label className="block col-span-1">
              <span className="text-sm text-gray-500">Categoria de Produto</span>
              <select value={filtroCategoria} onChange={e => setFiltroCategoria(e.target.value)} className="mt-1 block w-full p-3 border rounded-xl bg-white">
                {categorias.map(c => <option key={c} value={c}>{c}</option>)}
              </select>
            </label>
            
            <button 
                onClick={handlePrint} 
                className="w-full h-full md:mt-6 py-3 px-4 bg-purple-600 text-white font-semibold rounded-xl hover:bg-purple-700 transition col-span-1"
            >
                üñ®Ô∏è Imprimir
            </button>
            
            <button 
                onClick={handleLimparDados}
                disabled={!to}
                className={`w-full h-full md:mt-6 py-3 px-4 text-white font-semibold rounded-xl transition col-span-1 ${!to ? 'bg-gray-400' : 'bg-red-600 hover:bg-red-700'}`}
                title="Limpar Vendas, Pedidos e Comandas Fechadas at√© a Data Final selecionada"
            >
                üóëÔ∏è Limpar Dados
            </button>

          </div>
        </div>

        {/* √ÅREA DE IMPRESS√ÉO/EXIBI√á√ÉO */}
        <div id="relatorio-print-area" ref={printAreaRef} className="bg-white p-6 rounded-2xl shadow print:shadow-none">
            <h3 className="text-xl font-bold mb-4 border-b pb-2 print:text-center print:text-black">
                Resumo de Vendas ({vendasFiltradas.length} Registros)
            </h3>
        
            {vendasFiltradas.length === 0 ? (
                <div className="text-center text-gray-500 p-8">Nenhuma venda encontrada com os filtros aplicados.</div>
            ) : (
                <div className="space-y-8">
                    {/* 1. ESTAT√çSTICAS CHAVE */}
                    <div className="grid grid-cols-3 gap-4 border p-4 rounded-xl bg-gray-50 print:border print:bg-white">
                        <div className="text-center">
                            <div className="text-xs text-gray-500">Total de Vendas</div>
                            <div className="font-bold text-lg">{stats.totalVendas}</div>
                        </div>
                        <div className="text-center">
                            <div className="text-xs text-gray-500">Receita Total</div>
                            <div className="font-bold text-lg text-green-600">{currency(stats.receitaTotal)}</div>
                        </div>
                        <div className="text-center">
                            <div className="text-xs text-gray-500">Ticket M√©dio</div>
                            <div className="font-bold text-lg">{currency(stats.ticketMedio)}</div>
                        </div>
                    </div>

                    {/* 2. LISTAGEM DETALHADA DE VENDAS */}
                    <div>
                        <h4 className="font-bold mb-3 text-lg text-indigo-700">üìú Detalhe de Vendas Filtradas</h4>
                        <div className="overflow-x-auto">
                            <table className="w-full text-sm print-table">
                                <thead className="bg-gray-200">
                                    <tr>
                                        <th className="p-2 text-left">ID</th>
                                        <th className="p-2 text-left">Data/Hora</th>
                                        <th className="p-2 text-left">Pagamento (Origem)</th>
                                        <th className="p-2 text-left">Itens Vendidos</th>
                                        <th className="p-2 text-right">Total</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {vendasFiltradas.map((v) => (
                                        <tr key={v.id} className="border-b hover:bg-gray-50">
                                            <td className="p-2 text-gray-500 text-xs">{v.id}</td>
                                            <td className="p-2 text-xs">{formatDateTime(v.data)}</td>
                                            <td className="p-2 text-xs">
                                                {v.origem === 'PDV Balc√£o' ? 'Venda Direta' : 'Comanda'}
                                            </td>
                                            <td className="p-2 text-xs">
                                                {v.itens.map(i => `${i.quantidade}x ${i.nome}`).join(', ')}
                                            </td>
                                            <td className="p-2 text-right font-bold text-green-600">{currency(v.total)}</td>
                                        </tr>
                                    ))}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            )}
        </div>
      </div>
    );
  }

  /****************
    * Main App *
    ****************/
  function App(){
    const [user, setUser] = useState(null);
    const [loading, setLoading] = useState(true);
    
    const [produtos, setProdutos] = useState([]);
    const [vendas, setVendas] = useState([]);
    const [pedidos, setPedidos] = useState([]);
    const [comandas, setComandas] = useState([]);
    
    const [carrinho, setCarrinho] = useState([]);
    const [busca, setBusca] = useState('');
    const [selected, setSelected] = useState('pdv');

    // Fun√ß√µes de Limpeza de Dados
    
    function limparPedidosFinalizados() {
        const finalizadosCount = pedidos.filter(p => p.status === 'Vendido' || p.status === 'Consumo Entregue').length;
        if (finalizadosCount === 0) return alert('Nenhum pedido finalizado para apagar.');
        
        if (!confirm(`Tem certeza que deseja apagar ${finalizadosCount} pedidos finalizados permanentemente?`)) return;
        
        const novosPedidos = pedidos.filter(p => p.status !== 'Vendido' && p.status !== 'Consumo Entregue');
        setPedidos(novosPedidos);
        alert(`${finalizadosCount} pedidos finalizados foram apagados.`);
    }
    
    function limparDadosPorData(dataLimiteISO) {
        // Formato: YYYY-MM-DD
        const dataLimite = dataLimiteISO;
        
        // 1. Limpar Vendas
        const vendasApagar = vendas.filter(v => v.data.split('T')[0] <= dataLimite);
        const novasVendas = vendas.filter(v => v.data.split('T')[0] > dataLimite);
        setVendas(novasVendas);

        // 2. Limpar Comandas Fechadas
        // Filtra pelo dataFechamento, que √© adicionado ao fechar a comanda (no sistema)
        const comandasFechadasApagar = comandas.filter(c => c.status === 'Fechada' && c.dataFechamento && c.dataFechamento.split('T')[0] <= dataLimite);
        const novasComandas = comandas.filter(c => c.status !== 'Fechada' || c.dataFechamento.split('T')[0] > dataLimite);
        setComandas(novasComandas);

        // 3. Limpar Pedidos Finalizados
        // Pedidos s√£o marcados como vendidos na finaliza√ß√£o, data √© a data original do pedido
        const pedidosFinalizadosApagar = pedidos.filter(p => (p.status === 'Vendido' || p.status === 'Consumo Entregue') && p.data.split('T')[0] <= dataLimite);
        const novosPedidos = pedidos.filter(p => (p.status !== 'Vendido' && p.status !== 'Consumo Entregue') || p.data.split('T')[0] > dataLimite);
        setPedidos(novosPedidos);
        
        alert(`Limpeza conclu√≠da! ${vendasApagar.length} Vendas, ${comandasFechadasApagar.length} Comandas Fechadas e ${pedidosFinalizadosApagar.length} Pedidos Finalizados foram apagados permanentemente at√© ${dataLimite.split('-').reverse().join('/')}.`);
    }


    // Carrega dados do Firebase na inicializa√ß√£o
    useEffect(() => {
      async function initData() {
        try {
          let prods = await storageGet('produtos', null);
          if (!prods || prods.length === 0) {
            await storageSet('produtos', initialProdutosDefault);
            prods = initialProdutosDefault;
          }
          
          const vendsObj = await storageGet('vendas', {});
          const pedsObj = await storageGet('pedidos', {});
          const comsObj = await storageGet('comandas', {});
          
          // Tratamento para arrays do Firebase
          const vends = vendsObj ? Object.values(vendsObj).filter(v => v !== null) : [];
          const peds = pedsObj ? Object.values(pedsObj).filter(p => p !== null) : [];
          const coms = comsObj ? Object.values(comsObj).filter(c => c !== null) : [];
          
          setProdutos(prods);
          setVendas(vends);
          setPedidos(peds);
          setComandas(coms);
        } catch(e) {
          console.error('Erro ao carregar dados:', e);
          alert('Erro ao conectar com Firebase. Verifique as credenciais e regras de seguran√ßa!');
        } finally {
          setLoading(false);
        }
      }
      
      initData();
      
      const setupListener = (refPath, setState) => {
          const ref = db.ref(refPath);
          ref.on('value', (snapshot) => {
              if (snapshot.exists()) {
                  // Filtra nulls para garantir arrays limpos
                  setState(Object.values(snapshot.val() || {}).filter(item => item !== null));
              } else {
                  setState([]);
              }
          });
          return ref;
      };

      const refPedidos = setupListener('pedidos', setPedidos);
      const refComandas = setupListener('comandas', setComandas);
      const refProdutos = setupListener('produtos', setProdutos);
      const refVendas = setupListener('vendas', setVendas);
      
      return () => {
        refPedidos.off();
        refComandas.off();
        refProdutos.off();
        refVendas.off(); 
      };
    }, []);

    // Salva automaticamente quando dados mudam
    useEffect(() => { if (!loading && produtos.length > 0) storageSet('produtos', produtos); }, [produtos, loading]);
    useEffect(() => { if (!loading) storageSet('vendas', vendas); }, [vendas, loading]);
    useEffect(() => { if (!loading) storageSet('pedidos', pedidos); }, [pedidos, loading]);
    useEffect(() => { if (!loading) storageSet('comandas', comandas); }, [comandas, loading]);

    const salvarProdutos = (novos) => setProdutos(novos);

    function adicionarAoCarrinho(produto){ 
      const itemExistente = carrinho.find(i=>i.id===produto.id);
      const produtoEmEstoque = produtos.find(p=>p.id===produto.id);

      if (produtoEmEstoque.estoque <= (itemExistente?.quantidade || 0)) {
        alert(`Estoque insuficiente para ${produto.nome}`);
        return;
      }

      if(itemExistente){
        setCarrinho(carrinho.map(i => i.id===produto.id ? {...i, quantidade: i.quantidade+1} : i));
      } else {
        setCarrinho([...carrinho, {...produto, quantidade:1}]);
      }
    }

    function alterarQuantidade(id, novaQuantidade){ 
      const produtoEmEstoque = produtos.find(p=>p.id===id);
      
      if(novaQuantidade <= 0) {
        removerDoCarrinho(id);
      } else if (novaQuantidade > produtoEmEstoque.estoque) {
        alert(`M√°ximo: ${produtoEmEstoque.estoque}`);
      } else {
        setCarrinho(carrinho.map(i=> i.id===id ? {...i, quantidade:novaQuantidade} : i));
      }
    }

    function removerDoCarrinho(id){ setCarrinho(carrinho.filter(i=>i.id!==id)); }

    function finalizarVenda(){
      if(carrinho.length === 0) return alert('Carrinho vazio!');
      const total = carrinho.reduce((s,i)=> s + i.preco * i.quantidade, 0);
      
      const venda = { 
        id: uid(), 
        data: new Date().toISOString(), 
        itens: carrinho.map(i => ({ id: i.id, nome: i.nome, preco: i.preco, quantidade: i.quantidade })), 
        total: total,
        origem: 'PDV Balc√£o' 
      };
      
      const novosProdutos = produtos.map(produto => {
        const itemVendido = carrinho.find(item => item.id === produto.id);
        if(itemVendido) return {...produto, estoque: produto.estoque - itemVendido.quantidade};
        return produto;
      });
      
      salvarProdutos(novosProdutos);
      setVendas([...vendas, venda]);
      setCarrinho([]);
      alert(`Venda finalizada! Total: ${currency(total)}`);
    }
    
    function abrirComanda(){
      if(carrinho.length === 0) return alert('Carrinho vazio!');
      
      const nomeCliente = prompt("Nome do cliente:");
      if (!nomeCliente || nomeCliente.trim() === '') return alert("Nome obrigat√≥rio");

      const novosProdutos = produtos.map(produto => {
        const itemComprado = carrinho.find(item => item.id === produto.id);
        if(itemComprado) return {...produto, estoque: produto.estoque - itemComprado.quantidade};
        return produto;
      });
      salvarProdutos(novosProdutos);

      const novaComanda = {
        id: uid(),
        dataAbertura: new Date().toISOString(),
        nomeCliente: nomeCliente.trim(),
        mesaFixa: `MESA ${comandas.length + 1}`,
        valorInicial: totalCarrinho,
        status: 'Aberta',
        itensPrePagos: carrinho.map(i => ({ 
          id: i.id, 
          nome: i.nome, 
          quantidadeTotal: i.quantidade,
          quantidadeDisponivel: i.quantidade,
          preco: i.preco
        })), 
      };

      setComandas([...comandas, novaComanda]);
      setCarrinho([]);
      setSelected('comandas');
      alert(`Comanda ${novaComanda.nomeCliente} aberta!`);
    }
    
    function consumirItemPrePago(comandaId, itemId, quantidade = 1) {
      const novasComandas = comandas.map(comanda => {
        if (comanda.id === comandaId) {
          const novosItens = comanda.itensPrePagos.map(item => {
            if (item.id === itemId) {
              return {...item, quantidadeDisponivel: item.quantidadeDisponivel - quantidade}; 
            }
            return item;
          });
          return {...comanda, itensPrePagos: novosItens};
        }
        return comanda;
      });

      setComandas(novasComandas);
      
      const comanda = comandas.find(c => c.id === comandaId);
      const itemConsumido = comanda.itensPrePagos.find(i => i.id === itemId);
      
      const registroConsumo = {
        id: uid(),
        data: new Date().toISOString(),
        nomeCliente: comanda.nomeCliente,
        itens: [{ id: itemId, nome: itemConsumido.nome, preco: itemConsumido.preco, quantidade: quantidade }],
        total: itemConsumido.preco * quantidade,
        status: 'Em Preparo',
        comandaId: comandaId,
        tipo: 'Consumo Pre-pago'
      };
      setPedidos([...pedidos, registroConsumo]);
    }

    function fecharComandaEGerarVenda(comanda) {
      const vendaFinal = {
        id: comanda.id,
        data: new Date().toISOString(),
        itens: comanda.itensPrePagos.map(i => ({ 
          id: i.id, 
          nome: i.nome, 
          quantidade: i.quantidadeTotal, 
          preco: i.preco
        })), 
        total: comanda.valorInicial, 
        origem: `Comanda - ${comanda.nomeCliente}`,
        dataFechamento: new Date().toISOString()
      };

      setVendas([...vendas, vendaFinal]);
      setComandas(comandas.map(c => c.id === comanda.id ? {...c, status: 'Fechada', dataFechamento: vendaFinal.dataFechamento} : c));
      alert(`Comanda ${comanda.nomeCliente} fechada!`);
    }

    function finalizarPedidoEGerarVenda(pedido) {
      if (!confirm(`Finalizar pedido de ${pedido.nomeCliente}?`)) return;

      const novaVenda = {
        id: pedido.id,
        data: new Date().toISOString(),
        itens: pedido.itens,
        total: pedido.total,
        origem: `Pedido - ${pedido.nomeCliente}`
      };

      const novosProdutos = produtos.map(produto => {
        const itemVendido = pedido.itens.find(item => item.id === produto.id);
        if (itemVendido) return { ...produto, estoque: produto.estoque - itemVendido.quantidade };
        return produto;
      });
      
      salvarProdutos(novosProdutos);
      setVendas([...vendas, novaVenda]);
      setPedidos(pedidos.map(p => p.id === pedido.id ? { ...p, status: 'Vendido' } : p));
      
      alert(`Venda registrada! ${currency(pedido.total)}`);
    }

    const totalCarrinho = carrinho.reduce((s,i)=> s + i.preco * i.quantidade, 0);
    
    if(loading) return (
      <div className="min-h-screen flex items-center justify-center bg-gradient-to-br from-cinzaEscuro via-preto to-cinzaEscuro">
        <div className="text-center">
          <div className="text-6xl mb-4">‚è≥</div>
          <div className="text-2xl text-dourado font-bold">Carregando Firebase...</div>
        </div>
      </div>
    );
    
    if(!user) return <Login onLogin={setUser} />;

    return (
      <div className="min-h-screen flex flex-col bg-slate-50">
        <Header user={user} onLogout={()=>setUser(null)} />
        <div className="max-w-7xl mx-auto flex flex-1 w-full overflow-hidden">
          <Sidebar selected={selected} setSelected={setSelected} />
          <main className="flex-1 p-6 overflow-y-auto">
            <div className="flex items-center justify-between mb-6">
              <h1 className="text-2xl font-bold">Painel PDV</h1>
            </div>

            {selected === 'pdv' && (
              <PDVView produtos={produtos} adicionarAoCarrinho={adicionarAoCarrinho} busca={busca} setBusca={setBusca}
                    carrinho={carrinho} alterarQuantidade={alterarQuantidade} removerDoCarrinho={removerDoCarrinho}
                    finalizarVenda={finalizarVenda} totalCarrinho={totalCarrinho} abrirComanda={abrirComanda} />
            )}

            {selected === 'pedidos' && (
              <PedidosView pedidos={pedidos} setPedidos={setPedidos} 
                finalizarPedidoEGerarVenda={finalizarPedidoEGerarVenda}
                limparPedidosFinalizados={limparPedidosFinalizados}
                comandas={comandas} />
            )}
            
            {selected === 'comandas' && (
              <ComandasView comandas={comandas} 
                fecharComandaEGerarVenda={fecharComandaEGerarVenda}
                consumirItemPrePago={consumirItemPrePago} />
            )}

            {selected === 'produtos' && (
              <ProdutosView produtos={produtos} salvarProdutos={salvarProdutos} />
            )}

            {selected === 'relatorios' && (
              <RelatoriosView vendas={vendas} produtos={produtos} />
            )}

            {selected === 'avancado' && (
              <RelatorioAvancado vendas={vendas} produtos={produtos} comandas={comandas} limparDadosPorData={limparDadosPorData} />
            )}
          </main>
        </div>
      </div>
    );
  }

  ReactDOM.render(<App />, document.getElementById('root'));
  </script>
</body>

</html>
