<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Card√°pio Digital - Bar do Gigante</title>

  <script src="https://cdn.tailwindcss.com"></script>
  <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  
  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>

  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            dourado: '#D4AF37',
            douradoEscuro: '#B8941F',
            preto: '#1a1a1a',
            cinzaEscuro: '#2d2d2d',
          }
        }
      }
    }
  </script>

  <style>
    body { -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale; }
    .logo-bar-text {
      font-size: 22px; font-weight: bold; color: #D4AF37;
      letter-spacing: 2px; text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
      line-height: 1;
    }
  </style>
</head>
<body class="bg-gradient-to-br from-preto via-cinzaEscuro to-preto">

  <div id="root"></div>

  <script type="text/babel">
  const { useState, useEffect, useMemo } = React;

  /**********************
   * CONFIGURA√á√ÉO FIREBASE *
   **********************/
  
  // ‚ö†Ô∏è SUBSTITUA PELAS MESMAS CREDENCIAIS DO PDV!
  const firebaseConfig = {
  apiKey: "AIzaSyCB5k2sLKlSopQ5xes6e_1ctpXnHA2Pluo",
  authDomain: "bar-do-gigante.firebaseapp.com",
  databaseURL: "https://bar-do-gigante-default-rtdb.firebaseio.com",
  projectId: "bar-do-gigante",
  storageBucket: "bar-do-gigante.firebasestorage.app",
  messagingSenderId: "818575087702",
  appId: "1:818575087702:web:e488390c6f8ec6471b83f7"
};

  if (!firebase.apps.length) {
    firebase.initializeApp(firebaseConfig);
  }
  const db = firebase.database();

  /**********************
   * Utilit√°rios *
   **********************/
  function uid(){ return Date.now() + Math.floor(Math.random()*9999); }
  function currency(v){ return 'R$ ' + Number(v||0).toFixed(2).replace('.', ','); }

  async function storageGet(key, fallback=null){ 
    try {
      const snapshot = await db.ref(key).once('value');
      return snapshot.exists() ? snapshot.val() : fallback;
    } catch(e){ 
      console.error('Erro Firebase:', e);
      return fallback; 
    }
  }

  async function storageSet(key, value){ 
    try {
      await db.ref(key).set(value);
    } catch(e){
      console.error('Erro Firebase:', e);
    }
  }

  function storageWatch(key, callback) {
    db.ref(key).on('value', (snapshot) => {
      if (snapshot.exists()) {
        callback(snapshot.val());
      }
    });
  }

  /*************************
   * View de Comanda Ativa *
   *************************/
  function ComandaAtivaView({ comanda, enviarPedidoConsumo }) {
    const itensDisponiveis = comanda.itensPrePagos.filter(i => i.quantidadeDisponivel > 0);
    const [itensPedido, setItensPedido] = useState([]);
    
    function adicionarAoPedido(item) {
      if (item.quantidadeDisponivel <= 0) return alert("Item esgotado");
      
      const itemExistente = itensPedido.find(i => i.id === item.id);
      const quantidadeNoPedido = itemExistente ? itemExistente.quantidade : 0;
      
      if (quantidadeNoPedido >= item.quantidadeDisponivel) {
        return alert(`M√°ximo ${item.quantidadeDisponivel} dispon√≠veis`);
      }
      
      if (itemExistente) {
        setItensPedido(itensPedido.map(i => i.id === item.id ? {...i, quantidade: i.quantidade + 1} : i));
      } else {
        setItensPedido([...itensPedido, {...item, quantidade: 1}]);
      }
    }
    
    function removerDoPedido(id) {
      setItensPedido(itensPedido.filter(i => i.id !== id));
    }

    function handleEnviarPedido() {
      if (itensPedido.length === 0) return alert("Adicione itens ao pedido");
      
      const pedido = {
        nomeCliente: comanda.nomeCliente,
        itens: itensPedido
      };
      
      enviarPedidoConsumo(pedido);
      setItensPedido([]);
    }

    return (
      <div className="p-6 md:p-10 min-h-screen">
        <div className="text-center mb-10">
          <h1 className="text-4xl font-extrabold text-dourado logo-bar-text">BAR DO GIGANTE</h1>
          <p className="text-xl text-gray-300 mt-2">Bem-vindo(a), {comanda.nomeCliente}!</p>
          <p className="text-lg text-green-400 mt-1">Comanda Ativa ({comanda.mesaFixa})</p>
        </div>

        <div className="max-w-6xl mx-auto grid grid-cols-1 lg:grid-cols-3 gap-8">
          
          <div className="lg:col-span-2 space-y-4">
            <h3 className="font-bold text-2xl text-dourado">Itens Pr√©-pagos Dispon√≠veis:</h3>
            <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6">
              {itensDisponiveis.map(item => (
                <div key={item.id}
                     onClick={()=>adicionarAoPedido(item)}
                     className="p-4 rounded-2xl border border-dourado cursor-pointer shadow-xl hover:shadow-2xl transition bg-cinzaEscuro text-white">
                  <div className="flex items-start justify-between gap-3">
                    <div>
                      <div className="font-semibold text-xl text-dourado">{item.nome}</div>
                    </div>
                    <div className="text-right">
                      <div className="text-green-400 font-bold text-3xl">{item.quantidadeDisponivel}</div>
                      <div className="text-xs text-gray-400">Dispon√≠vel</div>
                    </div>
                  </div>
                  <div className="mt-3 border-t border-preto pt-2">
                    <div className="text-sm text-dourado font-semibold">Adicionar ‚ûï</div>
                  </div>
                </div>
              ))}
              {itensDisponiveis.length === 0 && (
                <div className="lg:col-span-3 text-center text-gray-400 p-8 border rounded-xl border-douradoEscuro">
                  Voc√™ consumiu todos os itens pr√©-pagos!
                </div>
              )}
            </div>
          </div>

          <div className="p-5 rounded-2xl shadow-xl h-full flex flex-col bg-cinzaEscuro border-dourado border">
            <h3 className="font-bold text-2xl flex items-center gap-2 text-dourado">üì¢ Pedido</h3>
            
            <div className="flex-1 max-h-[50vh] overflow-y-auto space-y-3 mt-4">
              {itensPedido.map(item => (
                <div key={item.id} className="p-3 border border-douradoEscuro rounded-lg bg-preto flex justify-between items-center">
                  <div className="font-medium text-dourado">{item.quantidade}x {item.nome}</div>
                  <button onClick={()=>removerDoPedido(item.id)} className="text-red-400 text-sm hover:underline">Remover</button>
                </div>
              ))}
              {itensPedido.length === 0 && <div className="text-gray-400 text-center py-6">Selecione itens</div>}
            </div>

            <div className="mt-6 border-t border-dourado pt-4">
              <button 
                onClick={handleEnviarPedido} 
                disabled={itensPedido.length === 0}
                className="w-full py-3 rounded-xl font-bold bg-gradient-to-r from-green-500 to-teal-400 text-preto shadow-lg hover:shadow-xl transition disabled:opacity-50"
              >
                Enviar Pedido
              </button>
            </div>
          </div>
        </div>
      </div>
    );
  }

  /*************************
   * View de Cliente Novo *
   *************************/
  function CardapioView({ produtosEmEstoque, setNomeCliente, nomeCliente, carrinho, adicionarAoCarrinho, totalCarrinho, enviarPedidoComanda }) {
    const [busca, setBusca] = useState('');
    
    const produtosFiltrados = produtosEmEstoque.filter(p => 
      p.nome.toLowerCase().includes(busca.toLowerCase()) || 
      p.categoria.toLowerCase().includes(busca.toLowerCase())
    );
    
    function handleAdicionar(produto) {
      if (!nomeCliente || nomeCliente.trim() === '') {
        alert('Digite seu nome antes de adicionar produtos');
        return;
      }
      adicionarAoCarrinho(produto);
    }

    return (
      <div className="p-6 md:p-10 min-h-screen">
        <div className="text-center mb-10">
          <h1 className="text-4xl font-extrabold text-dourado logo-bar-text">BAR DO GIGANTE</h1>
          <p className="text-xl text-gray-300 mt-2">Card√°pio Digital - Fa√ßa seu pedido!</p>
        </div>

        <div className="max-w-6xl mx-auto grid grid-cols-1 lg:grid-cols-3 gap-8">
          
          <div className="lg:col-span-3 mb-4">
            <div className="p-4 rounded-xl shadow-lg flex gap-3 items-center bg-cinzaEscuro border-dourado border">
              <input 
                type="text"
                placeholder="Seu Nome ou Mesa (Ex: Jo√£o, MESA 5)" 
                value={nomeCliente} 
                onChange={e => setNomeCliente(e.target.value)} 
                className="flex-1 p-3 border border-douradoEscuro bg-preto text-white rounded-lg focus:ring-2 focus:ring-dourado transition" 
              />
            </div>
          </div>

          <div className="lg:col-span-2 space-y-4">
            <div className="p-4 rounded-xl shadow-lg flex gap-3 items-center bg-cinzaEscuro border-dourado border">
              <input 
                type="search"
                value={busca} 
                onChange={e=>setBusca(e.target.value)} 
                placeholder="Pesquisar produto" 
                className="flex-1 p-3 border border-douradoEscuro bg-preto text-white rounded-lg focus:ring-2 focus:ring-dourado transition" 
              />
            </div>
            <h3 className="font-bold text-2xl text-dourado">Card√°pio (Pagamento no Final):</h3>
            <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6">
              {produtosFiltrados.map(produto => (
                <div key={produto.id}
                     onClick={()=>handleAdicionar(produto)}
                     className="p-4 rounded-2xl border border-dourado cursor-pointer shadow-xl hover:shadow-2xl transition bg-preto text-white">
                  <div className="flex items-start justify-between gap-3">
                    <div>
                      <div className="text-sm text-douradoEscuro">{produto.categoria}</div>
                      <div className="font-semibold text-lg mt-1 text-dourado">{produto.nome}</div>
                    </div>
                    <div className="text-right">
                      <div className="text-green-400 font-bold text-xl">{currency(produto.preco)}</div>
                    </div>
                  </div>
                  <div className="mt-3 flex items-center justify-between border-t border-cinzaEscuro pt-2">
                    <div className="text-xs text-gray-400">Adicionar</div>
                    <div className="text-sm text-dourado font-semibold">‚ûï</div>
                  </div>
                </div>
              ))}
            </div>
          </div>

          <div className="p-5 rounded-2xl shadow-xl h-full flex flex-col bg-cinzaEscuro border-dourado border">
            <h3 className="font-bold text-2xl flex items-center gap-2 text-dourado">üìã Meu Pedido</h3>
            
            <div className="flex-1 max-h-[50vh] overflow-y-auto space-y-3 mt-4">
              {carrinho.map(item=>(
                <div key={item.id} className="p-3 border border-douradoEscuro rounded-lg bg-preto">
                  <div className="font-medium text-dourado">{item.quantidade}x {item.nome}</div>
                  <div className="text-xs text-gray-500">{currency(item.preco)} cada</div>
                </div>
              ))}
              {carrinho.length===0 && <div className="text-gray-400 text-center py-6">Adicione itens</div>}
            </div>

            <div className="mt-6 border-t border-dourado pt-4">
              <div className="flex items-center justify-between font-bold text-2xl mb-4">
                <div>Total</div>
                <div className="text-green-400">{currency(totalCarrinho)}</div>
              </div>
              <button 
                onClick={enviarPedidoComanda} 
                disabled={!nomeCliente || carrinho.length === 0}
                className="w-full py-3 rounded-xl font-bold bg-gradient-to-r from-green-500 to-teal-400 text-preto shadow-lg transition disabled:opacity-50"
              >
                Enviar Pedido
              </button>
            </div>
          </div>
        </div>
      </div>
    );
  }

  /****************
   * Main App *
   ****************/
  function App(){
    const [loading, setLoading] = useState(true);
    const [nomeCliente, setNomeCliente] = useState('');
    const [carrinho, setCarrinho] = useState([]);
    
    const [todosProdutos, setTodosProdutos] = useState([]);
    const [pedidos, setPedidos] = useState([]);
    const [comandas, setComandas] = useState([]);

    // Carrega dados do Firebase
    useEffect(() => {
      async function loadData() {
        try {
          const prods = await storageGet('produtos', []);
          const peds = await storageGet('pedidos', []);
          const coms = await storageGet('comandas', []);
          
          setTodosProdutos(prods);
          setPedidos(peds);
          setComandas(coms);
        } catch(e) {
          console.error('Erro ao carregar:', e);
          alert('Erro ao conectar Firebase!');
        } finally {
          setLoading(false);
        }
      }
      
      loadData();
      
      // Escuta atualiza√ß√µes em tempo real
      storageWatch('produtos', setTodosProdutos);
      storageWatch('comandas', setComandas);
      
      return () => {
        db.ref('produtos').off();
        db.ref('comandas').off();
      };
    }, []);

    const produtosEmEstoque = todosProdutos.filter(p => p.estoque > 0);

    // Verifica comanda ativa
    const comandaAtiva = useMemo(() => {
      if (!nomeCliente) return null;
      const nomeLower = nomeCliente.toLowerCase().trim();
      return comandas.find(c => c.nomeCliente.toLowerCase().trim() === nomeLower && c.status === 'Aberta');
    }, [nomeCliente, comandas]);

    function adicionarAoCarrinho(produto){
      const itemExistente = carrinho.find(i=>i.id===produto.id);
      const produtoEmEstoque = todosProdutos.find(p=>p.id===produto.id);

      if (produtoEmEstoque.estoque <= (itemExistente?.quantidade || 0)) {
        alert(`Estoque insuficiente`);
        return;
      }

      if(itemExistente){
        setCarrinho(carrinho.map(i => i.id===produto.id ? {...i, quantidade: i.quantidade+1} : i));
      } else {
        setCarrinho([...carrinho, {...produto, quantidade:1}]);
      }
    }
    
    async function enviarPedidoComanda(){
      if(carrinho.length === 0 || !nomeCliente) return alert('Informe nome e itens');
      
      const total = carrinho.reduce((s,i)=> s + i.preco * i.quantidade, 0);

      const novoPedido = { 
        id: uid(), 
        data: new Date().toISOString(), 
        nomeCliente: nomeCliente.trim(),
        itens: carrinho.map(i => ({ id: i.id, nome: i.nome, preco: i.preco, quantidade: i.quantidade })), 
        total: total,
        status: 'Pendente' 
      };
      
      const novosPedidos = [...pedidos, novoPedido];
      await storageSet('pedidos', novosPedidos);
      setPedidos(novosPedidos);
      
      setCarrinho([]); 
      alert(`Pedido de ${nomeCliente} enviado!`);
    }
    
    async function enviarPedidoConsumo(pedido) {
      if (!comandaAtiva) return;

      const novoPedido = { 
        id: uid(), 
        data: new Date().toISOString(), 
        nomeCliente: pedido.nomeCliente,
        itens: pedido.itens,
        total: pedido.itens.reduce((s, i) => s + (i.preco * i.quantidade), 0),
        status: 'Em Preparo', 
        comandaId: comandaAtiva.id,
        tipo: 'Consumo Pre-pago'
      };
      
      const novosPedidos = [...pedidos, novoPedido];
      await storageSet('pedidos', novosPedidos);
      setPedidos(novosPedidos);
      
      alert(`Pedido enviado para cozinha!`);
    }

    const totalCarrinho = carrinho.reduce((s,i)=> s + i.preco * i.quantidade, 0);

    if(loading) return (
      <div className="min-h-screen flex items-center justify-center">
        <div className="text-center">
          <div className="text-6xl mb-4">‚è≥</div>
          <div className="text-2xl text-dourado font-bold">Carregando...</div>
        </div>
      </div>
    );

    if (comandaAtiva) {
      return <ComandaAtivaView comanda={comandaAtiva} enviarPedidoConsumo={enviarPedidoConsumo} />;
    }

    return (
      <CardapioView 
        produtosEmEstoque={produtosEmEstoque} 
        carrinho={carrinho}
        totalCarrinho={totalCarrinho}
        setNomeCliente={setNomeCliente} 
        nomeCliente={nomeCliente}
        adicionarAoCarrinho={adicionarAoCarrinho}
        enviarPedidoComanda={enviarPedidoComanda} 
      />
    );
  }

  ReactDOM.render(<App />, document.getElementById('root'));
  </script>
</body>
</html>